diff --git a/js-bs-6/handlers.js b/js-bs-6/handlers.js
index 91b687e62c995e3b06f56aeaf77838196237ae15..11eaea35f07e49e781f8d7326db2aab266804af5 100644
--- a/js-bs-6/handlers.js
+++ b/js-bs-6/handlers.js
@@ -1,43 +1,47 @@
 // js/handlers.js
 import { uuidRegex, extractUUIDsFromString, copyToClipboard } from './utils.js';
 import { parsePanText, parseCSVTextGeneric } from './parsers.js';
 import { appendLog, setCounters } from './ui.js';
 import { doFetch } from './api.js';
 import { sleep, waitWhilePaused } from './utils.js';
 
 export function buildPayloadForRow(dom, row) {
   const uuid = row.transaction_uuid;
-  if (dom.modeEl.value === 'pay_type') {
-    return { transaction_uuid: uuid, pay_type: Number(dom.payTypeEl.value) };
-  } else if (dom.modeEl.value === 'pan_change') {
-    return { transaction_uuid: uuid, grn: row.pan || '', comment: dom.commentEl.value.trim() };
-  } else {
-    const comment = dom.commentEl.value.trim()
-      || String(document.getElementById('ticketId')?.value || '').trim();
-    return { transaction_uuid: uuid, grn: dom.grnEl.value.trim(), comment };
-  }
+  if (dom.modeEl.value === 'pay_type') {
+    return { transaction_uuid: uuid, pay_type: Number(dom.payTypeEl.value) };
+  } else if (dom.modeEl.value === 'pan_change') {
+    const comment = dom.commentEl.value.trim()
+      || String(document.getElementById('ticketId')?.value || '').trim();
+    const payload = { transaction_uuid: uuid, grn: row.pan || '' };
+    if (comment) payload.comment = comment;
+    return payload;
+  } else {
+    const comment = dom.commentEl.value.trim()
+      || String(document.getElementById('ticketId')?.value || '').trim();
+    return { transaction_uuid: uuid, grn: dom.grnEl.value.trim(), comment };
+  }
 }
 
 export async function parseSource(dom, state) {
   state.parsedRows = [];
   const src = dom.sourceEl.value;
 
   if (src === 'file') {
     const f = dom.csvFile.files[0];
     if (!f) { appendLog(dom, 'Нет выбранного файла', 'err'); return; }
     const text = await f.text();
 
     if (dom.modeEl.value === 'pan_change') {
       state.parsedRows = parsePanText(text);
     } else if (dom.fastExtractEl.checked) {
       const uuids = extractUUIDsFromString(text);
       state.parsedRows = Array.from(new Set(uuids)).map(uuid => ({ transaction_uuid: uuid }));
     } else {
       const parsed = parseCSVTextGeneric(text, dom.useFirstColIfHeaderEl.checked);
       state.parsedRows = parsed.rows;
 
       if (parsed.header && dom.uuidColEl.value.trim()) {
         const col = dom.uuidColEl.value.trim();
         state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[col] || r[Object.keys(r)[0]] || '' }));
       } else if (parsed.header && !dom.uuidColEl.value.trim()) {
         const colWithUuid = parsed.header.find(h => parsed.rows.some(r => uuidRegex.test(r[h])));
@@ -185,62 +189,64 @@ export function bindUiHandlers(dom, state, { updateUrlByMode }) {
   const CLOSE_PERIODS_SQL = 'update l3core_payments.e_fin_periods set "period_state"=3 where "period_state"=2;';
   const PERIODS_API_URL = 'http://192.168.11.90:3003/periods';
 
   const updatePeriods = async (action, sql) => {
     try {
       const response = await fetch(`${PERIODS_API_URL}/${action}`, { method: 'POST' });
       if (!response.ok) {
         const message = await response.text();
         throw new Error(message || `Ошибка сети: ${response.status}`);
       }
       const data = await response.json().catch(() => ({}));
       const updated = typeof data.updated === 'number' ? data.updated : null;
       appendLog(
         dom,
         `Готово: ${action === 'open' ? 'открытие' : 'закрытие'} периодов` +
           (updated !== null ? `, обновлено строк: ${updated}` : ''),
         'ok'
       );
     } catch (error) {
       appendLog(dom, `Ошибка при ${action === 'open' ? 'открытии' : 'закрытии'} периодов: ${error.message}`, 'err');
       await copyToClipboard(sql);
       appendLog(dom, 'SQL скопирован в буфер обмена для ручного запуска', 'info');
     }
   };
 
-  if (dom.btnTransferText) {
-    dom.btnTransferText.addEventListener('click', () => {
-      const text = dom.inputTextEl?.value.trim();
-      if (!text) {
-        appendLog(dom, 'Текст для парсинга пуст — нечего переносить', 'err');
-        return;
-      }
-      dom.sourceEl.value = 'textarea';
-      dom.textArea.value = text;
-      appendLog(dom, 'Текст перенесён в Sender textarea', 'ok');
-    });
-  }
+  if (dom.btnTransferText) {
+    dom.btnTransferText.addEventListener('click', () => {
+      const text = dom.inputTextEl?.value.trim();
+      if (!text) {
+        appendLog(dom, 'Текст для парсинга пуст — нечего переносить', 'err');
+        return;
+      }
+      dom.modeEl.value = 'pan_change';
+      dom.modeEl.dispatchEvent(new Event('change'));
+      dom.sourceEl.value = 'textarea';
+      dom.textArea.value = text;
+      appendLog(dom, 'Текст перенесён в Sender textarea', 'ok');
+    });
+  }
 
   if (dom.btnOpenPeriods) {
     dom.btnOpenPeriods.addEventListener('click', async () => {
       await updatePeriods('open', OPEN_PERIODS_SQL);
     });
   }
 
   if (dom.btnClosePeriods) {
     dom.btnClosePeriods.addEventListener('click', async () => {
       await updatePeriods('close', CLOSE_PERIODS_SQL);
     });
   }
 
   // Pause
   if (dom.btnPause) {
     dom.btnPause.addEventListener('click', () => {
       state.paused = !state.paused;
       dom.btnPause.textContent = state.paused ? 'Resume' : 'Pause';
       appendLog(dom, state.paused ? 'Пауза включена' : 'Пауза снята', 'info');
     });
   }
 
   // Preview
   dom.btnPreview.addEventListener('click', async () => {
     await parseSource(dom, state);
 
EOF
)