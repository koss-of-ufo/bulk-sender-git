diff --git a/js-bs-6/dom.js b/js-bs-6/dom.js
index bca2ec8b889b5d28872be6d8a6fc558cf0f040fa..695216b9b957b27e9271cab86d4635e9c89cf9f5 100644
--- a/js-bs-6/dom.js
+++ b/js-bs-6/dom.js
@@ -1,54 +1,56 @@
 // js/dom.js
 export function getDom() {
   // DOM
   const csvFile = document.getElementById('csvFile');
   const textArea = document.getElementById('textArea');
   const sourceEl = document.getElementById('source');
   const btnPreview = document.getElementById('btnPreview');
   const btnSendOne = document.getElementById('btnSendOne');
   const btnSendAll = document.getElementById('btnSendAll');
   const btnStop = document.getElementById('btnStop');
   const btnDownloadErrors = document.getElementById('btnDownloadErrors');
   const btnDownloadReport = document.getElementById('btnDownloadReport');
   const previewBox = document.getElementById('previewBox');
   const logBox = document.getElementById('logBox');
   const totalEl = document.getElementById('total');
   const successEl = document.getElementById('success');
   const failEl = document.getElementById('fail');
   const progressEl = document.getElementById('progress');
   const inputTextEl = document.getElementById('inputText');
 
   const urlEl = document.getElementById('url');
   const authEl = document.getElementById('auth');
   const methodEl = document.getElementById('method');
-  const modeEl = document.getElementById('mode');
-  const payTypeEl = document.getElementById('payType');
+  const modeEl = document.getElementById('mode');
+  const modeSidebarEl = document.getElementById('modeSidebar');
+  const payTypeEl = document.getElementById('payType');
+  const classEl = document.getElementById('classValue');
   const delayEl = document.getElementById('delay');
   const grnEl = document.getElementById('grn');
   const commentEl = document.getElementById('comment');
   const uuidColEl = document.getElementById('uuidCol');
   const fastExtractEl = document.getElementById('fastExtract');
   const autoDownloadErrorsEl = document.getElementById('autoDownloadErrors');
   const skipPreviewEl = document.getElementById('skipPreview');
   const useFirstColIfHeaderEl = document.getElementById('useFirstColIfHeader');
   const autoClosePeriodsEl = document.getElementById('autoClosePeriods');
 
   const btnPause = document.getElementById('btnPause');
   const btnTransferText = document.getElementById('btnTransferText');
   const btnOpenPeriods = document.getElementById('btnOpenPeriods');
   const btnClosePeriods = document.getElementById('btnClosePeriods');
 
   return {
     csvFile, textArea, sourceEl,
     btnPreview, btnSendOne, btnSendAll, btnStop,
     btnDownloadErrors, btnDownloadReport,
     previewBox, logBox,
     totalEl, successEl, failEl, progressEl,
     inputTextEl,
-    urlEl, authEl, methodEl, modeEl, payTypeEl,
+    urlEl, authEl, methodEl, modeEl, modeSidebarEl, payTypeEl, classEl,
     delayEl, grnEl, commentEl, uuidColEl,
     fastExtractEl, autoDownloadErrorsEl,
     skipPreviewEl, useFirstColIfHeaderEl, autoClosePeriodsEl,
     btnPause, btnTransferText, btnOpenPeriods, btnClosePeriods,
   };
 }
diff --git a/js-bs-6/handlers.js b/js-bs-6/handlers.js
index 4e93a47b6cd9fa485936c1a8ed4f88bf41c31b1e..626fc7ef8854313000dee9c27746c7e935e6d0bc 100644
--- a/js-bs-6/handlers.js
+++ b/js-bs-6/handlers.js
@@ -1,467 +1,478 @@
-// js/handlers.js
-import { uuidRegex, extractUUIDsFromString, copyToClipboard } from './utils.js';
-import { parsePanText, parseCSVTextGeneric } from './parsers.js';
-import { appendLog, setCounters } from './ui.js';
-import { doFetch } from './api.js';
-import { sleep, waitWhilePaused } from './utils.js';
-
-export function buildPayloadForRow(dom, row) {
-  const uuid = row.transaction_uuid;
-  if (dom.modeEl.value === 'pay_type') {
-    return { transaction_uuid: uuid, pay_type: Number(dom.payTypeEl.value) };
-  } else if (dom.modeEl.value === 'pan_change') {
-    const comment = dom.commentEl.value.trim()
-      || String(document.getElementById('ticketId')?.value || '').trim();
-    const payload = { transaction_uuid: uuid, grn: row.pan || '' };
-    if (comment) payload.comment = comment;
-    return payload;
-  } else {
-    const comment = dom.commentEl.value.trim()
-      || String(document.getElementById('ticketId')?.value || '').trim();
-    return { transaction_uuid: uuid, grn: dom.grnEl.value.trim(), comment };
-  }
-}
-
-export async function parseSource(dom, state) {
-  state.parsedRows = [];
-  const src = dom.sourceEl.value;
-
-  if (src === 'file') {
-    const f = dom.csvFile.files[0];
-    if (!f) { appendLog(dom, 'Нет выбранного файла', 'err'); return; }
-    const text = await f.text();
-
-    if (dom.modeEl.value === 'pan_change') {
-      state.parsedRows = parsePanText(text);
-    } else if (dom.fastExtractEl.checked) {
-      const uuids = extractUUIDsFromString(text);
-      state.parsedRows = Array.from(new Set(uuids)).map(uuid => ({ transaction_uuid: uuid }));
-    } else {
-      const parsed = parseCSVTextGeneric(text, dom.useFirstColIfHeaderEl.checked);
-      state.parsedRows = parsed.rows;
-
-      if (parsed.header && dom.uuidColEl.value.trim()) {
-        const col = dom.uuidColEl.value.trim();
-        state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[col] || r[Object.keys(r)[0]] || '' }));
-      } else if (parsed.header && !dom.uuidColEl.value.trim()) {
-        const colWithUuid = parsed.header.find(h => parsed.rows.some(r => uuidRegex.test(r[h])));
-        if (colWithUuid) state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[colWithUuid] || '' }));
-        else state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[Object.keys(r)[0]] || '' }));
-      }
-    }
-  } else {
-    const text = dom.textArea.value.trim();
-    if (!text) { appendLog(dom, 'Textarea пуст', 'err'); return; }
-
-    if (dom.modeEl.value === 'pan_change') {
-      state.parsedRows = parsePanText(text);
-    } else if (dom.fastExtractEl.checked) {
-      const uuids = extractUUIDsFromString(text);
-      state.parsedRows = Array.from(new Set(uuids)).map(uuid => ({ transaction_uuid: uuid }));
-    } else {
-      const parsed = parseCSVTextGeneric(text, dom.useFirstColIfHeaderEl.checked);
-      state.parsedRows = parsed.rows;
-
-      if (parsed.header && dom.uuidColEl.value.trim()) {
-        const col = dom.uuidColEl.value.trim();
-        state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[col] || r[Object.keys(r)[0]] || '' }));
-      } else if (parsed.header) {
-        const colWithUuid = parsed.header.find(h => parsed.rows.some(r => uuidRegex.test(r[h])));
-        if (colWithUuid) state.parsedRows = parsed.rows.map(r => ({ transaction_uuid: r[colWithUuid] || '' }));
-        else state.parsedRows = parsed.rows.map(r => ({ transaction_uuid: r[Object.keys(r)[0]] || '' }));
-      }
-    }
-  }
-
-  state.parsedRows = state.parsedRows.map(r => {
-    const val = String(r.transaction_uuid || '').trim();
-    const found = val.match(uuidRegex);
-    if (found) return { transaction_uuid: found[0], pan: r.pan || '' };
-    const tokens = val.split(/[\s,;]+/).filter(Boolean);
-    if (tokens.length === 1) return { transaction_uuid: tokens[0], pan: r.pan || '' };
-    return { transaction_uuid: tokens[0] || val, pan: r.pan || '' };
-  });
-
-  state.parsedRows = state.parsedRows.filter(r => r.transaction_uuid && (dom.modeEl.value !== 'pan_change' || r.pan));
-
-  appendLog(dom, `Парсинг завершён: ${state.parsedRows.length} UUID`, 'info');
-  state.report = [];
-  state.errors = [];
-  setCounters(dom, state);
-}
-
-export function downloadErrors(dom, state) {
-  if (!state.errors.length) { appendLog(dom, 'Нет ошибок для скачивания', 'info'); return; }
-  const header = ['index', 'uuid', 'status', 'body'];
-  const rowsCsv = [header.join(',')];
-
-  state.errors.forEach(e => {
-    const safe = v => `"${String(v || '').replace(/"/g, '""')}"`;
-    rowsCsv.push([e.index, safe(e.uuid), safe(e.status), safe(e.body)].join(','));
-  });
-
-  const blob = new Blob([rowsCsv.join('\n')], { type: 'text/csv;charset=utf-8;' });
-  const a = document.createElement('a');
-  a.href = URL.createObjectURL(blob);
-  a.download = 'errors.csv';
-  document.body.appendChild(a);
-  a.click();
-  a.remove();
-  appendLog(dom, 'errors.csv скачан', 'info');
-}
-
-export function downloadReport(dom, state) {
-  if (!state.report.length) { appendLog(dom, 'Нет отчёта для скачивания', 'info'); return; }
-  const header = ['index', 'uuid', 'ok', 'status', 'body'];
-  const rowsCsv = [header.join(',')];
-
-  state.report.forEach(r => {
-    const safe = v => `"${String(v || '').replace(/"/g, '""')}"`;
-    rowsCsv.push([r.index, safe(r.uuid), r.ok ? '1' : '0', safe(r.status), safe(r.body)].join(','));
-  });
-
-  const blob = new Blob([rowsCsv.join('\n')], { type: 'text/csv;charset=utf-8;' });
-  const a = document.createElement('a');
-  a.href = URL.createObjectURL(blob);
-  a.download = 'report.csv';
-  document.body.appendChild(a);
-  a.click();
-  a.remove();
-  appendLog(dom, 'report.csv скачан', 'info');
-}
-
-export function initTokenPersistence(dom) {
-  const LS_KEY = 'bulk_sender_api_token';
-  if (!dom.authEl) return;
-
-  const savedToken = localStorage.getItem(LS_KEY);
-  if (savedToken) dom.authEl.value = savedToken;
-
-  dom.authEl.addEventListener('input', () => {
-    localStorage.setItem(LS_KEY, dom.authEl.value.trim());
-  });
-
-  dom.authEl.addEventListener('blur', () => {
-    let v = dom.authEl.value.trim();
-    if (v && !v.toLowerCase().startsWith('bearer ')) {
-      v = 'Bearer ' + v;
-      dom.authEl.value = v;
-      localStorage.setItem(LS_KEY, v);
-    }
-  });
-}
-
-export function bindWindowEvents(dom, state) {
-  window.addEventListener('parsed-uuids-ready', (event) => {
-    const uuids = Array.isArray(event.detail?.uuids) ? event.detail.uuids : [];
-    if (!uuids.length) {
-      appendLog(dom, 'Из парсера не пришли UUID', 'err');
-      return;
-    }
-    dom.sourceEl.value = 'textarea';
-    dom.textArea.value = uuids.join('\n');
-    appendLog(dom, `UUID из парсера подставлены в textarea: ${uuids.length}`, 'ok');
-  });
-
-  window.addEventListener('parsed-grn-mode-ready', (event) => {
-    const uuid = String(event.detail?.uuid || '').trim();
-    const grn = String(event.detail?.grn || '').trim();
-    const uuids = Array.isArray(event.detail?.uuids) ? event.detail.uuids : [];
-
-    if (!uuid || !grn) {
-      appendLog(dom, 'Недостаточно данных из парсера для grn+comment', 'err');
-      return;
-    }
-
-    dom.modeEl.value = 'grn_comment';
-    dom.modeEl.dispatchEvent(new Event('change'));
-
-    dom.sourceEl.value = 'textarea';
-    dom.textArea.value = (uuids.length ? uuids : [uuid]).join('\n');
-    dom.grnEl.value = grn;
-
-    appendLog(dom, `Подставлены данные из парсера: mode=grn+comment, UUID=${uuid}, GRN=${grn}`, 'ok');
-  });
-}
-
-export function bindUiHandlers(dom, state, { updateUrlByMode }) {
-  const OPEN_PERIODS_SQL = 'update l3core_payments.e_fin_periods set "period_state"=2 where "period_state"=3;';
-  const CLOSE_PERIODS_SQL = 'update l3core_payments.e_fin_periods set "period_state"=3 where "period_state"=2;';
-  const PERIODS_API_URL = 'http://192.168.11.90:3003/periods';
-
-  const updatePeriods = async (action, sql) => {
-    try {
-      const response = await fetch(`${PERIODS_API_URL}/${action}`, { method: 'POST' });
-      if (!response.ok) {
-        const message = await response.text();
-        throw new Error(message || `Ошибка сети: ${response.status}`);
-      }
-      const data = await response.json().catch(() => ({}));
-      const updated = typeof data.updated === 'number' ? data.updated : null;
-      appendLog(
-        dom,
-        `Готово: ${action === 'open' ? 'открытие' : 'закрытие'} периодов` +
-          (updated !== null ? `, обновлено строк: ${updated}` : ''),
-        'ok'
-      );
-    } catch (error) {
-      appendLog(dom, `Ошибка при ${action === 'open' ? 'открытии' : 'закрытии'} периодов: ${error.message}`, 'err');
-      await copyToClipboard(sql);
-      appendLog(dom, 'SQL скопирован в буфер обмена для ручного запуска', 'info');
-    }
-  };
-
-  if (dom.btnTransferText) {
-    dom.btnTransferText.addEventListener('click', () => {
-      const text = dom.inputTextEl?.value.trim();
-      if (!text) {
-        appendLog(dom, 'Текст для парсинга пуст — нечего переносить', 'err');
-        return;
-      }
-      dom.modeEl.value = 'pan_change';
-      dom.modeEl.dispatchEvent(new Event('change'));
-      dom.sourceEl.value = 'textarea';
-      dom.textArea.value = text;
-      appendLog(dom, 'Текст перенесён в Sender textarea', 'ok');
-    });
-  }
-
-  if (dom.btnOpenPeriods) {
-    dom.btnOpenPeriods.addEventListener('click', async () => {
-      await updatePeriods('open', OPEN_PERIODS_SQL);
-    });
-  }
-
-  if (dom.btnClosePeriods) {
-    dom.btnClosePeriods.addEventListener('click', async () => {
-      await updatePeriods('close', CLOSE_PERIODS_SQL);
-    });
-  }
-
-  // Pause
-  if (dom.btnPause) {
-    dom.btnPause.addEventListener('click', () => {
-      state.paused = !state.paused;
-      dom.btnPause.textContent = state.paused ? 'Resume' : 'Pause';
-      appendLog(dom, state.paused ? 'Пауза включена' : 'Пауза снята', 'info');
-    });
-  }
-
-  // Preview
-  dom.btnPreview.addEventListener('click', async () => {
-    await parseSource(dom, state);
-    if (!state.parsedRows.length) return alert('Нет UUID после парсинга');
-    const n = Math.min(10, state.parsedRows.length);
-    const list = [];
-    for (let i = 0; i < n; i++) list.push(buildPayloadForRow(dom, state.parsedRows[i]));
-    dom.previewBox.textContent = JSON.stringify(list, null, 2);
-    appendLog(dom, `PREVIEW: показано ${n} записей`, 'info');
-  });
-
-  // Send 1
-  dom.btnSendOne.addEventListener('click', async () => {
-    await parseSource(dom, state);
-    if (!state.parsedRows.length) return alert('Нет UUID для отправки');
-    const payload = buildPayloadForRow(dom, state.parsedRows[0]);
-    appendLog(dom, `Отправляю тестовую: ${JSON.stringify(payload)}`, 'info');
-
-    state.abortController = new AbortController();
-    try {
-      const res = await doFetch(dom, state, payload);
-      state.report.push({ index: 1, uuid: payload.transaction_uuid, ok: res.ok, status: res.status, body: res.body });
-
-      if (res.ok) {
-        appendLog(dom, `OK ${res.status} ${payload.transaction_uuid} → ${typeof res.body === 'object' ? JSON.stringify(res.body) : res.body}`, 'ok');
-      } else {
-        appendLog(dom, `ERR ${res.status} ${payload.transaction_uuid} → ${typeof res.body === 'object' ? JSON.stringify(res.body) : res.body}`, 'err');
-        state.errors.push({ index: 1, uuid: payload.transaction_uuid, status: res.status, body: typeof res.body === 'object' ? JSON.stringify(res.body) : res.body });
-      }
-
-      setCounters(dom, state);
-    } catch (e) {
-      if (e.name === 'AbortError') appendLog(dom, 'Тестовая отправка отменена', 'err');
-      else appendLog(dom, 'Ошибка тестовой отправки: ' + e, 'err');
-    } finally {
-      state.abortController = null;
-    }
-  });
-
-  // Stop
-  dom.btnStop.addEventListener('click', () => {
-    state.running = false;
-    if (state.abortController) state.abortController.abort();
-    state.abortController = null;
-
-    appendLog(dom, 'Процесс остановлен пользователем', 'err');
-
-    dom.btnStop.disabled = true;
-
-    state.paused = false;
-    dom.btnPause.disabled = true;
-    dom.btnPause.textContent = 'Pause';
-  });
-
-  // Send All
-  dom.btnSendAll.addEventListener('click', async () => {
-    await parseSource(dom, state);
-    if (!state.parsedRows.length) return alert('Нет UUID для отправки');
-    if (state.running) return alert('Уже выполняется отправка');
-
-    if (!dom.skipPreviewEl.checked) {
-      const proceed = confirm('Сделать Preview (первые 10)? Нажмите Отмена чтобы продолжить без Preview.');
-      if (proceed) {
-        const list = state.parsedRows.slice(0, Math.min(10, state.parsedRows.length))
-          .map(r => buildPayloadForRow(dom, r));
-        dom.previewBox.textContent = JSON.stringify(list, null, 2);
-        const ok = confirm('Просмотрен PREVIEW. Нажмите ОК для продолжения массовой отправки.');
-        if (!ok) { appendLog(dom, 'Массовая отправка отменена после Preview', 'err'); return; }
-      }
-    }
-
-    state.running = true;
-    state.abortController = new AbortController();
-
-    dom.btnPause.disabled = false;
-    dom.btnPause.textContent = 'Pause';
-    state.paused = false;
-
-    dom.btnStop.disabled = false;
-
-    state.errors = [];
-    state.report = [];
-    let completedAll = true;
-
-    appendLog(dom, `Начинаю массовую отправку ${state.parsedRows.length} записей, delay=${dom.delayEl.value} ms`, 'info');
-    const delayMs = Math.max(0, Number(dom.delayEl.value) || 200);
-
-    for (let i = 0; i < state.parsedRows.length; i++) {
-      if (!state.running) {
-        completedAll = false;
-        break;
-      }
-
-      await waitWhilePaused(state);
-      if (!state.running) {
-        completedAll = false;
-        break;
-      }
-
-      const payload = buildPayloadForRow(dom, state.parsedRows[i]);
-      appendLog(dom, `#${i + 1} ${payload.transaction_uuid} → ${JSON.stringify(payload)}`, 'info');
-
-      try {
-        let res = await doFetch(dom, state, payload);
-
-        if (res.status === 429) {
-          appendLog(dom, `429 Too Many Requests. Автопауза на 90с...`, 'err');
-
-          for (let t = 0; t < 90; t++) {
-            if (!state.running) {
-              completedAll = false;
-              break;
-            }
-            await waitWhilePaused(state);
-            await sleep(1000);
-          }
-          if (!state.running) {
-            completedAll = false;
-            break;
-          }
-
-          appendLog(dom, `Повтор запроса после автопаузы: ${payload.transaction_uuid}`, 'info');
-          res = await doFetch(dom, state, payload);
-        }
-
-        state.report.push({
-          index: i + 1,
-          uuid: payload.transaction_uuid,
-          ok: res.ok,
-          status: res.status,
-          body: typeof res.body === 'object' ? JSON.stringify(res.body) : res.body
-        });
-
-        if (res.ok) {
-          appendLog(dom, `OK ${res.status} ${payload.transaction_uuid}`, 'ok');
-        } else {
-          appendLog(dom, `ERR ${res.status} ${payload.transaction_uuid} → ${typeof res.body === 'object' ? JSON.stringify(res.body) : res.body}`, 'err');
-          state.errors.push({
-            index: i + 1,
-            uuid: payload.transaction_uuid,
-            status: res.status,
-            body: typeof res.body === 'object' ? JSON.stringify(res.body) : res.body
-          });
-        }
-      } catch (e) {
-        if (e.name === 'AbortError') {
-          appendLog(dom, `Отмена (Abort) на ${payload.transaction_uuid}`, 'err');
-          state.report.push({ index: i + 1, uuid: payload.transaction_uuid, ok: false, status: 'aborted', body: 'aborted' });
-          state.errors.push({ index: i + 1, uuid: payload.transaction_uuid, status: 'aborted', body: 'aborted' });
-          completedAll = false;
-          break;
-        } else {
-          appendLog(dom, `NETWORK ERROR ${payload.transaction_uuid} → ${e}`, 'err');
-          state.report.push({ index: i + 1, uuid: payload.transaction_uuid, ok: false, status: 'network', body: String(e) });
-          state.errors.push({ index: i + 1, uuid: payload.transaction_uuid, status: 'network', body: String(e) });
-        }
-      }
-
-      setCounters(dom, state);
-
-      if (i < state.parsedRows.length - 1) {
-        let left = delayMs;
-        while (left > 0 && state.running) {
-          await waitWhilePaused(state);
-          const step = Math.min(200, left);
-          await sleep(step);
-          left -= step;
-        }
-      }
-    }
-
-    state.running = false;
-    state.abortController = null;
-
-    dom.btnStop.disabled = true;
-    dom.btnPause.disabled = true;
-    dom.btnPause.textContent = 'Pause';
-    state.paused = false;
-
-    appendLog(dom, `Массовая отправка завершена. Ошибок: ${state.errors.length}`, 'info');
-
-    if (dom.autoDownloadErrorsEl.checked && state.errors.length) {
-      downloadErrors(dom, state);
-    }
-
-    if (dom.autoClosePeriodsEl?.checked && completedAll && state.errors.length === 0) {
-      await updatePeriods('close', CLOSE_PERIODS_SQL);
-    }
-  });
-
-  // Download buttons
-  dom.btnDownloadErrors.addEventListener('click', () => downloadErrors(dom, state));
-  dom.btnDownloadReport.addEventListener('click', () => downloadReport(dom, state));
-
-  // Parse file on change
-  dom.csvFile.addEventListener('change', async () => {
-    const f = dom.csvFile.files[0];
-    if (!f) return;
-    const text = await f.text();
-
-    let count = 0;
-    if (dom.modeEl.value === 'pan_change') count = parsePanText(text).length;
-    else if (dom.fastExtractEl.checked) count = extractUUIDsFromString(text).length;
-    else {
-      const parsed = parseCSVTextGeneric(text, dom.useFirstColIfHeaderEl.checked);
-      if (parsed.rows) count = parsed.rows.length;
-    }
-
-    appendLog(dom, `Файл выбран. Примерно строк: ${count}`, 'info');
-    state.parsedRows = [];
-    state.report = [];
-    state.errors = [];
-    setCounters(dom, state);
-  });
-
-  // Mode -> URL
-  dom.modeEl.addEventListener('change', () => updateUrlByMode(dom));
-}
+// js/handlers.js
+import { uuidRegex, extractUUIDsFromString, copyToClipboard } from './utils.js';
+import { parsePanText, parseCSVTextGeneric } from './parsers.js';
+import { appendLog, setCounters } from './ui.js';
+import { doFetch } from './api.js';
+import { sleep, waitWhilePaused } from './utils.js';
+
+export function buildPayloadForRow(dom, row) {
+  const uuid = row.transaction_uuid;
+  if (dom.modeEl.value === 'pay_type') {
+    return { transaction_uuid: uuid, pay_type: Number(dom.payTypeEl.value) };
+  } else if (dom.modeEl.value === 'class_change') {
+    return { transaction_uuid: uuid, class: Number(dom.classEl.value) };
+  } else if (dom.modeEl.value === 'pan_change') {
+    const comment = dom.commentEl.value.trim()
+      || String(document.getElementById('ticketId')?.value || '').trim();
+    const payload = { transaction_uuid: uuid, grn: row.pan || '' };
+    if (comment) payload.comment = comment;
+    return payload;
+  } else {
+    const comment = dom.commentEl.value.trim()
+      || String(document.getElementById('ticketId')?.value || '').trim();
+    return { transaction_uuid: uuid, grn: dom.grnEl.value.trim(), comment };
+  }
+}
+
+export async function parseSource(dom, state) {
+  state.parsedRows = [];
+  const src = dom.sourceEl.value;
+
+  if (src === 'file') {
+    const f = dom.csvFile.files[0];
+    if (!f) { appendLog(dom, 'Нет выбранного файла', 'err'); return; }
+    const text = await f.text();
+
+    if (dom.modeEl.value === 'pan_change') {
+      state.parsedRows = parsePanText(text);
+    } else if (dom.fastExtractEl.checked) {
+      const uuids = extractUUIDsFromString(text);
+      state.parsedRows = Array.from(new Set(uuids)).map(uuid => ({ transaction_uuid: uuid }));
+    } else {
+      const parsed = parseCSVTextGeneric(text, dom.useFirstColIfHeaderEl.checked);
+      state.parsedRows = parsed.rows;
+
+      if (parsed.header && dom.uuidColEl.value.trim()) {
+        const col = dom.uuidColEl.value.trim();
+        state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[col] || r[Object.keys(r)[0]] || '' }));
+      } else if (parsed.header && !dom.uuidColEl.value.trim()) {
+        const colWithUuid = parsed.header.find(h => parsed.rows.some(r => uuidRegex.test(r[h])));
+        if (colWithUuid) state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[colWithUuid] || '' }));
+        else state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[Object.keys(r)[0]] || '' }));
+      }
+    }
+  } else {
+    const text = dom.textArea.value.trim();
+    if (!text) { appendLog(dom, 'Textarea пуст', 'err'); return; }
+
+    if (dom.modeEl.value === 'pan_change') {
+      state.parsedRows = parsePanText(text);
+    } else if (dom.fastExtractEl.checked) {
+      const uuids = extractUUIDsFromString(text);
+      state.parsedRows = Array.from(new Set(uuids)).map(uuid => ({ transaction_uuid: uuid }));
+    } else {
+      const parsed = parseCSVTextGeneric(text, dom.useFirstColIfHeaderEl.checked);
+      state.parsedRows = parsed.rows;
+
+      if (parsed.header && dom.uuidColEl.value.trim()) {
+        const col = dom.uuidColEl.value.trim();
+        state.parsedRows = state.parsedRows.map(r => ({ transaction_uuid: r[col] || r[Object.keys(r)[0]] || '' }));
+      } else if (parsed.header) {
+        const colWithUuid = parsed.header.find(h => parsed.rows.some(r => uuidRegex.test(r[h])));
+        if (colWithUuid) state.parsedRows = parsed.rows.map(r => ({ transaction_uuid: r[colWithUuid] || '' }));
+        else state.parsedRows = parsed.rows.map(r => ({ transaction_uuid: r[Object.keys(r)[0]] || '' }));
+      }
+    }
+  }
+
+  state.parsedRows = state.parsedRows.map(r => {
+    const val = String(r.transaction_uuid || '').trim();
+    const found = val.match(uuidRegex);
+    if (found) return { transaction_uuid: found[0], pan: r.pan || '' };
+    const tokens = val.split(/[\s,;]+/).filter(Boolean);
+    if (tokens.length === 1) return { transaction_uuid: tokens[0], pan: r.pan || '' };
+    return { transaction_uuid: tokens[0] || val, pan: r.pan || '' };
+  });
+
+  state.parsedRows = state.parsedRows.filter(r => r.transaction_uuid && (dom.modeEl.value !== 'pan_change' || r.pan));
+
+  appendLog(dom, `Парсинг завершён: ${state.parsedRows.length} UUID`, 'info');
+  state.report = [];
+  state.errors = [];
+  setCounters(dom, state);
+}
+
+export function downloadErrors(dom, state) {
+  if (!state.errors.length) { appendLog(dom, 'Нет ошибок для скачивания', 'info'); return; }
+  const header = ['index', 'uuid', 'status', 'body'];
+  const rowsCsv = [header.join(',')];
+
+  state.errors.forEach(e => {
+    const safe = v => `"${String(v || '').replace(/"/g, '""')}"`;
+    rowsCsv.push([e.index, safe(e.uuid), safe(e.status), safe(e.body)].join(','));
+  });
+
+  const blob = new Blob([rowsCsv.join('\n')], { type: 'text/csv;charset=utf-8;' });
+  const a = document.createElement('a');
+  a.href = URL.createObjectURL(blob);
+  a.download = 'errors.csv';
+  document.body.appendChild(a);
+  a.click();
+  a.remove();
+  appendLog(dom, 'errors.csv скачан', 'info');
+}
+
+export function downloadReport(dom, state) {
+  if (!state.report.length) { appendLog(dom, 'Нет отчёта для скачивания', 'info'); return; }
+  const header = ['index', 'uuid', 'ok', 'status', 'body'];
+  const rowsCsv = [header.join(',')];
+
+  state.report.forEach(r => {
+    const safe = v => `"${String(v || '').replace(/"/g, '""')}"`;
+    rowsCsv.push([r.index, safe(r.uuid), r.ok ? '1' : '0', safe(r.status), safe(r.body)].join(','));
+  });
+
+  const blob = new Blob([rowsCsv.join('\n')], { type: 'text/csv;charset=utf-8;' });
+  const a = document.createElement('a');
+  a.href = URL.createObjectURL(blob);
+  a.download = 'report.csv';
+  document.body.appendChild(a);
+  a.click();
+  a.remove();
+  appendLog(dom, 'report.csv скачан', 'info');
+}
+
+export function initTokenPersistence(dom) {
+  const LS_KEY = 'bulk_sender_api_token';
+  if (!dom.authEl) return;
+
+  const savedToken = localStorage.getItem(LS_KEY);
+  if (savedToken) dom.authEl.value = savedToken;
+
+  dom.authEl.addEventListener('input', () => {
+    localStorage.setItem(LS_KEY, dom.authEl.value.trim());
+  });
+
+  dom.authEl.addEventListener('blur', () => {
+    let v = dom.authEl.value.trim();
+    if (v && !v.toLowerCase().startsWith('bearer ')) {
+      v = 'Bearer ' + v;
+      dom.authEl.value = v;
+      localStorage.setItem(LS_KEY, v);
+    }
+  });
+}
+
+export function bindWindowEvents(dom, state) {
+  window.addEventListener('parsed-uuids-ready', (event) => {
+    const uuids = Array.isArray(event.detail?.uuids) ? event.detail.uuids : [];
+    if (!uuids.length) {
+      appendLog(dom, 'Из парсера не пришли UUID', 'err');
+      return;
+    }
+    dom.sourceEl.value = 'textarea';
+    dom.textArea.value = uuids.join('\n');
+    appendLog(dom, `UUID из парсера подставлены в textarea: ${uuids.length}`, 'ok');
+  });
+
+  window.addEventListener('parsed-grn-mode-ready', (event) => {
+    const uuid = String(event.detail?.uuid || '').trim();
+    const grn = String(event.detail?.grn || '').trim();
+    const uuids = Array.isArray(event.detail?.uuids) ? event.detail.uuids : [];
+
+    if (!uuid || !grn) {
+      appendLog(dom, 'Недостаточно данных из парсера для grn+comment', 'err');
+      return;
+    }
+
+    dom.modeEl.value = 'grn_comment';
+    dom.modeEl.dispatchEvent(new Event('change'));
+
+    dom.sourceEl.value = 'textarea';
+    dom.textArea.value = (uuids.length ? uuids : [uuid]).join('\n');
+    dom.grnEl.value = grn;
+
+    appendLog(dom, `Подставлены данные из парсера: mode=grn+comment, UUID=${uuid}, GRN=${grn}`, 'ok');
+  });
+}
+
+export function bindUiHandlers(dom, state, { updateUrlByMode }) {
+  const OPEN_PERIODS_SQL = 'update l3core_payments.e_fin_periods set "period_state"=2 where "period_state"=3;';
+  const CLOSE_PERIODS_SQL = 'update l3core_payments.e_fin_periods set "period_state"=3 where "period_state"=2;';
+  const PERIODS_API_URL = 'http://192.168.11.90:3003/periods';
+
+  const updatePeriods = async (action, sql) => {
+    try {
+      const response = await fetch(`${PERIODS_API_URL}/${action}`, { method: 'POST' });
+      if (!response.ok) {
+        const message = await response.text();
+        throw new Error(message || `Ошибка сети: ${response.status}`);
+      }
+      const data = await response.json().catch(() => ({}));
+      const updated = typeof data.updated === 'number' ? data.updated : null;
+      appendLog(
+        dom,
+        `Готово: ${action === 'open' ? 'открытие' : 'закрытие'} периодов` +
+          (updated !== null ? `, обновлено строк: ${updated}` : ''),
+        'ok'
+      );
+    } catch (error) {
+      appendLog(dom, `Ошибка при ${action === 'open' ? 'открытии' : 'закрытии'} периодов: ${error.message}`, 'err');
+      await copyToClipboard(sql);
+      appendLog(dom, 'SQL скопирован в буфер обмена для ручного запуска', 'info');
+    }
+  };
+
+  if (dom.btnTransferText) {
+    dom.btnTransferText.addEventListener('click', () => {
+      const text = dom.inputTextEl?.value.trim();
+      if (!text) {
+        appendLog(dom, 'Текст для парсинга пуст — нечего переносить', 'err');
+        return;
+      }
+      dom.modeEl.value = 'pan_change';
+      dom.modeEl.dispatchEvent(new Event('change'));
+      dom.sourceEl.value = 'textarea';
+      dom.textArea.value = text;
+      appendLog(dom, 'Текст перенесён в Sender textarea', 'ok');
+    });
+  }
+
+  if (dom.btnOpenPeriods) {
+    dom.btnOpenPeriods.addEventListener('click', async () => {
+      await updatePeriods('open', OPEN_PERIODS_SQL);
+    });
+  }
+
+  if (dom.btnClosePeriods) {
+    dom.btnClosePeriods.addEventListener('click', async () => {
+      await updatePeriods('close', CLOSE_PERIODS_SQL);
+    });
+  }
+
+  // Pause
+  if (dom.btnPause) {
+    dom.btnPause.addEventListener('click', () => {
+      state.paused = !state.paused;
+      dom.btnPause.textContent = state.paused ? 'Resume' : 'Pause';
+      appendLog(dom, state.paused ? 'Пауза включена' : 'Пауза снята', 'info');
+    });
+  }
+
+  // Preview
+  dom.btnPreview.addEventListener('click', async () => {
+    await parseSource(dom, state);
+    if (!state.parsedRows.length) return alert('Нет UUID после парсинга');
+    const n = Math.min(10, state.parsedRows.length);
+    const list = [];
+    for (let i = 0; i < n; i++) list.push(buildPayloadForRow(dom, state.parsedRows[i]));
+    dom.previewBox.textContent = JSON.stringify(list, null, 2);
+    appendLog(dom, `PREVIEW: показано ${n} записей`, 'info');
+  });
+
+  // Send 1
+  dom.btnSendOne.addEventListener('click', async () => {
+    await parseSource(dom, state);
+    if (!state.parsedRows.length) return alert('Нет UUID для отправки');
+    const payload = buildPayloadForRow(dom, state.parsedRows[0]);
+    appendLog(dom, `Отправляю тестовую: ${JSON.stringify(payload)}`, 'info');
+
+    state.abortController = new AbortController();
+    try {
+      const res = await doFetch(dom, state, payload);
+      state.report.push({ index: 1, uuid: payload.transaction_uuid, ok: res.ok, status: res.status, body: res.body });
+
+      if (res.ok) {
+        appendLog(dom, `OK ${res.status} ${payload.transaction_uuid} → ${typeof res.body === 'object' ? JSON.stringify(res.body) : res.body}`, 'ok');
+      } else {
+        appendLog(dom, `ERR ${res.status} ${payload.transaction_uuid} → ${typeof res.body === 'object' ? JSON.stringify(res.body) : res.body}`, 'err');
+        state.errors.push({ index: 1, uuid: payload.transaction_uuid, status: res.status, body: typeof res.body === 'object' ? JSON.stringify(res.body) : res.body });
+      }
+
+      setCounters(dom, state);
+    } catch (e) {
+      if (e.name === 'AbortError') appendLog(dom, 'Тестовая отправка отменена', 'err');
+      else appendLog(dom, 'Ошибка тестовой отправки: ' + e, 'err');
+    } finally {
+      state.abortController = null;
+    }
+  });
+
+  // Stop
+  dom.btnStop.addEventListener('click', () => {
+    state.running = false;
+    if (state.abortController) state.abortController.abort();
+    state.abortController = null;
+
+    appendLog(dom, 'Процесс остановлен пользователем', 'err');
+
+    dom.btnStop.disabled = true;
+
+    state.paused = false;
+    dom.btnPause.disabled = true;
+    dom.btnPause.textContent = 'Pause';
+  });
+
+  // Send All
+  dom.btnSendAll.addEventListener('click', async () => {
+    await parseSource(dom, state);
+    if (!state.parsedRows.length) return alert('Нет UUID для отправки');
+    if (state.running) return alert('Уже выполняется отправка');
+
+    if (!dom.skipPreviewEl.checked) {
+      const proceed = confirm('Сделать Preview (первые 10)? Нажмите Отмена чтобы продолжить без Preview.');
+      if (proceed) {
+        const list = state.parsedRows.slice(0, Math.min(10, state.parsedRows.length))
+          .map(r => buildPayloadForRow(dom, r));
+        dom.previewBox.textContent = JSON.stringify(list, null, 2);
+        const ok = confirm('Просмотрен PREVIEW. Нажмите ОК для продолжения массовой отправки.');
+        if (!ok) { appendLog(dom, 'Массовая отправка отменена после Preview', 'err'); return; }
+      }
+    }
+
+    state.running = true;
+    state.abortController = new AbortController();
+
+    dom.btnPause.disabled = false;
+    dom.btnPause.textContent = 'Pause';
+    state.paused = false;
+
+    dom.btnStop.disabled = false;
+
+    state.errors = [];
+    state.report = [];
+    let completedAll = true;
+
+    appendLog(dom, `Начинаю массовую отправку ${state.parsedRows.length} записей, delay=${dom.delayEl.value} ms`, 'info');
+    const delayMs = Math.max(0, Number(dom.delayEl.value) || 200);
+
+    for (let i = 0; i < state.parsedRows.length; i++) {
+      if (!state.running) {
+        completedAll = false;
+        break;
+      }
+
+      await waitWhilePaused(state);
+      if (!state.running) {
+        completedAll = false;
+        break;
+      }
+
+      const payload = buildPayloadForRow(dom, state.parsedRows[i]);
+      appendLog(dom, `#${i + 1} ${payload.transaction_uuid} → ${JSON.stringify(payload)}`, 'info');
+
+      try {
+        let res = await doFetch(dom, state, payload);
+
+        if (res.status === 429) {
+          appendLog(dom, `429 Too Many Requests. Автопауза на 90с...`, 'err');
+
+          for (let t = 0; t < 90; t++) {
+            if (!state.running) {
+              completedAll = false;
+              break;
+            }
+            await waitWhilePaused(state);
+            await sleep(1000);
+          }
+          if (!state.running) {
+            completedAll = false;
+            break;
+          }
+
+          appendLog(dom, `Повтор запроса после автопаузы: ${payload.transaction_uuid}`, 'info');
+          res = await doFetch(dom, state, payload);
+        }
+
+        state.report.push({
+          index: i + 1,
+          uuid: payload.transaction_uuid,
+          ok: res.ok,
+          status: res.status,
+          body: typeof res.body === 'object' ? JSON.stringify(res.body) : res.body
+        });
+
+        if (res.ok) {
+          appendLog(dom, `OK ${res.status} ${payload.transaction_uuid}`, 'ok');
+        } else {
+          appendLog(dom, `ERR ${res.status} ${payload.transaction_uuid} → ${typeof res.body === 'object' ? JSON.stringify(res.body) : res.body}`, 'err');
+          state.errors.push({
+            index: i + 1,
+            uuid: payload.transaction_uuid,
+            status: res.status,
+            body: typeof res.body === 'object' ? JSON.stringify(res.body) : res.body
+          });
+        }
+      } catch (e) {
+        if (e.name === 'AbortError') {
+          appendLog(dom, `Отмена (Abort) на ${payload.transaction_uuid}`, 'err');
+          state.report.push({ index: i + 1, uuid: payload.transaction_uuid, ok: false, status: 'aborted', body: 'aborted' });
+          state.errors.push({ index: i + 1, uuid: payload.transaction_uuid, status: 'aborted', body: 'aborted' });
+          completedAll = false;
+          break;
+        } else {
+          appendLog(dom, `NETWORK ERROR ${payload.transaction_uuid} → ${e}`, 'err');
+          state.report.push({ index: i + 1, uuid: payload.transaction_uuid, ok: false, status: 'network', body: String(e) });
+          state.errors.push({ index: i + 1, uuid: payload.transaction_uuid, status: 'network', body: String(e) });
+        }
+      }
+
+      setCounters(dom, state);
+
+      if (i < state.parsedRows.length - 1) {
+        let left = delayMs;
+        while (left > 0 && state.running) {
+          await waitWhilePaused(state);
+          const step = Math.min(200, left);
+          await sleep(step);
+          left -= step;
+        }
+      }
+    }
+
+    state.running = false;
+    state.abortController = null;
+
+    dom.btnStop.disabled = true;
+    dom.btnPause.disabled = true;
+    dom.btnPause.textContent = 'Pause';
+    state.paused = false;
+
+    appendLog(dom, `Массовая отправка завершена. Ошибок: ${state.errors.length}`, 'info');
+
+    if (dom.autoDownloadErrorsEl.checked && state.errors.length) {
+      downloadErrors(dom, state);
+    }
+
+    if (dom.autoClosePeriodsEl?.checked && completedAll && state.errors.length === 0) {
+      await updatePeriods('close', CLOSE_PERIODS_SQL);
+    }
+  });
+
+  // Download buttons
+  dom.btnDownloadErrors.addEventListener('click', () => downloadErrors(dom, state));
+  dom.btnDownloadReport.addEventListener('click', () => downloadReport(dom, state));
+
+  // Parse file on change
+  dom.csvFile.addEventListener('change', async () => {
+    const f = dom.csvFile.files[0];
+    if (!f) return;
+    const text = await f.text();
+
+    let count = 0;
+    if (dom.modeEl.value === 'pan_change') count = parsePanText(text).length;
+    else if (dom.fastExtractEl.checked) count = extractUUIDsFromString(text).length;
+    else {
+      const parsed = parseCSVTextGeneric(text, dom.useFirstColIfHeaderEl.checked);
+      if (parsed.rows) count = parsed.rows.length;
+    }
+
+    appendLog(dom, `Файл выбран. Примерно строк: ${count}`, 'info');
+    state.parsedRows = [];
+    state.report = [];
+    state.errors = [];
+    setCounters(dom, state);
+  });
+
+  // Mode -> URL
+  const syncMode = (value) => {
+    if (dom.modeEl && dom.modeEl.value !== value) dom.modeEl.value = value;
+    if (dom.modeSidebarEl && dom.modeSidebarEl.value !== value) dom.modeSidebarEl.value = value;
+    updateUrlByMode(dom);
+  };
+
+  dom.modeEl.addEventListener('change', () => syncMode(dom.modeEl.value));
+  if (dom.modeSidebarEl) {
+    dom.modeSidebarEl.addEventListener('change', () => syncMode(dom.modeSidebarEl.value));
+  }
+}
diff --git a/js-bs-6/ui.js b/js-bs-6/ui.js
index facfc9a4f2101bb770e522b8370b1b2d9f97e96a..caa4aefee5729aeb17928f091e3b92707e744d50 100644
--- a/js-bs-6/ui.js
+++ b/js-bs-6/ui.js
@@ -1,24 +1,26 @@
-// js/ui.js
-export function appendLog(dom, text, type = 'info') {
-  const el = document.createElement('div');
-  el.className = 'line ' + (type === 'ok' ? 'ok' : type === 'err' ? 'err' : 'info');
-  el.textContent = (new Date()).toLocaleTimeString() + ' → ' + text;
-  dom.logBox.prepend(el);
-}
-
-export function setCounters(dom, state) {
-  dom.totalEl.textContent = state.parsedRows.length;
-  const succ = state.report.filter(r => r.ok).length;
-  const fails = state.report.filter(r => !r.ok).length;
-  dom.successEl.textContent = succ;
-  dom.failEl.textContent = fails;
-  dom.progressEl.textContent = `${state.report.length}/${state.parsedRows.length}`;
-}
-
-export function updateUrlByMode(dom) {
-  if (dom.modeEl.value === 'pay_type') {
-    dom.urlEl.value = 'http://10.2.201.200/api/ui/find-transactions/set_pay_type';
-  } else {
-    dom.urlEl.value = 'http://10.2.201.200/api/ui/find-transactions/set_grnz';
-  }
-}
+// js/ui.js
+export function appendLog(dom, text, type = 'info') {
+  const el = document.createElement('div');
+  el.className = 'line ' + (type === 'ok' ? 'ok' : type === 'err' ? 'err' : 'info');
+  el.textContent = (new Date()).toLocaleTimeString() + ' → ' + text;
+  dom.logBox.prepend(el);
+}
+
+export function setCounters(dom, state) {
+  dom.totalEl.textContent = state.parsedRows.length;
+  const succ = state.report.filter(r => r.ok).length;
+  const fails = state.report.filter(r => !r.ok).length;
+  dom.successEl.textContent = succ;
+  dom.failEl.textContent = fails;
+  dom.progressEl.textContent = `${state.report.length}/${state.parsedRows.length}`;
+}
+
+export function updateUrlByMode(dom) {
+  if (dom.modeEl.value === 'pay_type') {
+    dom.urlEl.value = 'http://10.2.201.200/api/ui/find-transactions/set_pay_type';
+  } else if (dom.modeEl.value === 'class_change') {
+    dom.urlEl.value = 'http://10.2.201.200/api/ui/find-transactions/set_class';
+  } else {
+    dom.urlEl.value = 'http://10.2.201.200/api/ui/find-transactions/set_grnz';
+  }
+}
diff --git a/tulza_set_pay_type_6.2.html b/tulza_set_pay_type_6.2.html
index 7bf9fa23bb77c58d530815083fbf8c222eb605d3..a1de4e304d2c70b175953ce0f535faca4829c508 100644
--- a/tulza_set_pay_type_6.2.html
+++ b/tulza_set_pay_type_6.2.html
@@ -1,1280 +1,1321 @@
-<!doctype html>
-<html lang="ru">
-
-<head>
-  <meta charset="utf-8" />
-  <meta name="viewport" content="width=device-width,initial-scale=1" />
-  <title>Bulk Sender Ultimate v6.2</title>
-  <link rel="icon" type="image/png" href="velik.png">
-
-  <style>
-    :root {
-      /* LIGHT (default) */
-      --bg: #e9eef6;
-      --card: #ffffff;
-      --muted: #475569;
-      --ok: #15803d;
-      --err: #dc2626;
-      --info: #0284c7;
-      --ink: #0b1220;
-      --border: #cbd5e1;
-      --soft: #eef2f7;
-      --blue: #1d4ed8;
-
-      --shadow: 0 10px 28px rgba(2, 6, 23, 0.10);
-      --shadow-soft: 0 6px 18px rgba(2, 6, 23, 0.08);
-      --ring: 0 0 0 4px rgba(29, 78, 216, 0.16);
-    }
-
-    /* DARK */
-    html[data-theme="dark"] {
-      --bg: #0b1220;
-      /* общий фон */
-      --card: #0f172a;
-      /* карточки */
-      --soft: #0b1324;
-      /* “soft” блоки */
-      --ink: #e5e7eb;
-      /* основной текст */
-      --muted: #94a3b8;
-      /* вторичный текст */
-      --border: #263244;
-      /* границы */
-
-      --blue: #3b82f6;
-      /* акцент */
-      --ok: #22c55e;
-      --err: #f87171;
-      --info: #38bdf8;
-
-      --shadow: 0 14px 34px rgba(0, 0, 0, 0.40);
-      --shadow-soft: 0 10px 22px rgba(0, 0, 0, 0.28);
-      --ring: 0 0 0 4px rgba(59, 130, 246, 0.22);
-    }
-
-
-    * {
-      box-sizing: border-box
-    }
-
-    body {
-      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
-      margin: 18px;
-      background: var(--bg);
-      color: var(--ink);
-    }
-
-    /* Layout shell */
-    .shell {
-      max-width: 1200px;
-      margin: 0 auto;
-      display: grid;
-      grid-template-columns: 1fr;
-      gap: 12px;
-    }
-
-    .card {
-      padding: 16px;
-      border-radius: 12px;
-      background: var(--card);
-      box-shadow: var(--shadow-soft);
-      border: 1px solid rgba(203, 213, 225, 0.9);
-    }
-
-    .card.soft {
-      background: var(--soft);
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      box-shadow: none;
-    }
-
-    h1 {
-      font-size: 18px;
-      margin: 0 0 8px;
-      line-height: 1.25;
-    }
-
-    h2 {
-      font-size: 15px;
-      margin: 0 0 8px;
-      line-height: 1.25;
-    }
-
-    h1,
-    h2 {
-      color: var(--ink);
-    }
-
-    h3 {
-      font-size: 13px;
-      margin: 0 0 8px;
-      line-height: 1.25;
-      color: var(--ink);
-      opacity: .9;
-    }
-
-    .small {
-      font-size: 12px;
-      color: var(--muted);
-    }
-
-    .small-muted {
-      font-size: 12px;
-      color: var(--muted);
-    }
-
-    .hint {
-      font-size: 12px;
-      color: var(--muted);
-      margin-top: 6px;
-    }
-
-    /* Sticky top bar */
-    .topbar {
-      position: sticky;
-      top: 10px;
-      z-index: 20;
-      padding: 10px 12px;
-      border-radius: 12px;
-      display: flex;
-      gap: 10px;
-      align-items: center;
-      justify-content: space-between;
-
-      background: rgba(255, 255, 255, 0.92);
-      backdrop-filter: blur(10px);
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      box-shadow: var(--shadow);
-    }
-
-    .topbar-left {
-      display: flex;
-      gap: 8px;
-      align-items: center;
-      flex-wrap: wrap;
-      min-width: 0;
-    }
-
-    .topbar-right {
-      display: flex;
-      gap: 8px;
-      align-items: center;
-      flex-wrap: wrap;
-    }
-
-    .pill {
-      padding: 6px 10px;
-      border-radius: 999px;
-      background: var(--soft);
-      /* darker chip */
-      font-weight: 800;
-      font-size: 12px;
-      display: inline-flex;
-      gap: 6px;
-      align-items: center;
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      color: var(--ink);
-    }
-
-    .pill.ok {
-      background: rgba(21, 128, 61, 0.14);
-      border-color: rgba(21, 128, 61, 0.24);
-      color: var(--ok);
-    }
-
-    .pill.err {
-      background: rgba(220, 38, 38, 0.14);
-      border-color: rgba(220, 38, 38, 0.24);
-      color: var(--err);
-    }
-
-    .pill.info {
-      background: rgba(2, 132, 199, 0.14);
-      border-color: rgba(2, 132, 199, 0.24);
-      color: var(--info);
-    }
-
-    .badge {
-      font-weight: 900;
-    }
-
-    .spacer {
-      flex: 1;
-      min-width: 10px;
-    }
-
-    /* Stepper */
-    .steps {
-      display: grid;
-      grid-template-columns: repeat(7, minmax(0, 1fr));
-      gap: 8px;
-      margin-top: 8px;
-    }
-
-    .step {
-      padding: 10px;
-      border-radius: 10px;
-      background: var(--card);
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      display: flex;
-      gap: 10px;
-      align-items: center;
-      min-width: 0;
-      box-shadow: 0 4px 10px rgba(2, 6, 23, 0.05);
-    }
-
-    .step .n {
-      width: 22px;
-      height: 22px;
-      border-radius: 999px;
-      background: rgba(29, 78, 216, 0.14);
-      color: #1d4ed8;
-      font-weight: 900;
-      display: grid;
-      place-items: center;
-      flex: 0 0 auto;
-      border: 1px solid rgba(29, 78, 216, 0.26);
-      font-size: 12px;
-    }
-
-    .step .t {
-      font-size: 12px;
-      font-weight: 900;
-      color: var(--ink);
-      white-space: nowrap;
-      overflow: hidden;
-      text-overflow: ellipsis;
-    }
-
-    @media (max-width: 1100px) {
-      .steps {
-        grid-template-columns: repeat(3, minmax(0, 1fr));
-      }
-    }
-
-    @media (max-width: 680px) {
-      .steps {
-        grid-template-columns: repeat(2, minmax(0, 1fr));
-      }
-    }
-
-    /* Forms */
-    label {
-      display: block;
-      font-size: 13px;
-      color: var(--ink);
-      margin-top: 8px;
-      font-weight: 700;
-    }
-
-    input[type=text],
-    select,
-    textarea {
-      width: 100%;
-      padding: 9px 10px;
-      border: 1px solid rgba(148, 163, 184, 0.7);
-      /* darker than #e6e9ef */
-      border-radius: 10px;
-      font-size: 14px;
-      outline: none;
-      background: var(--card);
-      color: var(--ink);
-    }
-
-    input[type=text]:focus,
-    select:focus,
-    textarea:focus {
-      border-color: rgba(29, 78, 216, 0.65);
-      box-shadow: var(--ring);
-    }
-
-    textarea {
-      min-height: 70px;
-      resize: vertical;
-    }
-
-    input[type=file] {
-      margin-top: 8px;
-    }
-
-    .highlight-select {
-      border: 2px solid rgba(29, 78, 216, 0.65);
-      background: rgba(29, 78, 216, 0.08);
-      padding: 7px 8px;
-      border-radius: 10px;
-      transition: 0.25s ease;
-      font-weight: 900;
-    }
-
-    .row {
-      display: grid;
-      grid-template-columns: repeat(3, minmax(0, 1fr));
-      gap: 12px;
-      align-items: start;
-    }
-
-    .row.two {
-      grid-template-columns: repeat(2, minmax(0, 1fr));
-    }
-
-    .row.one {
-      grid-template-columns: 1fr;
-    }
-
-    @media (max-width: 1024px) {
-
-      .row,
-      .row.two {
-        grid-template-columns: 1fr;
-      }
-    }
-
-    /* Buttons */
-    button {
-      background: var(--blue);
-      color: var(--card);
-      border: 0;
-      padding: 9px 12px;
-      border-radius: 10px;
-      cursor: pointer;
-      font-weight: 900;
-      font-size: 13px;
-      box-shadow: 0 6px 14px rgba(29, 78, 216, 0.18);
-    }
-
-    button:hover {
-      filter: brightness(0.98);
-    }
-
-    button.secondary {
-      background: #dbe3ee;
-      color: #0b1220;
-      box-shadow: 0 6px 14px rgba(2, 6, 23, 0.06);
-    }
-
-    button.warn {
-      background: var(--err);
-      color: var(--card);
-      box-shadow: 0 6px 14px rgba(220, 38, 38, 0.16);
-    }
-
-    button:disabled {
-      opacity: .6;
-      cursor: not-allowed;
-      box-shadow: none;
-    }
-
-    .controls {
-      display: flex;
-      gap: 8px;
-      align-items: center;
-      margin-top: 12px;
-      flex-wrap: wrap;
-    }
-
-    .controls.split {
-      justify-content: space-between;
-    }
-
-    .btn-group {
-      display: flex;
-      gap: 8px;
-      flex-wrap: wrap;
-    }
-
-    /* Sections / Accordions */
-    details.accordion {
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      border-radius: 12px;
-      background: var(--card);
-      overflow: hidden;
-    }
-
-    details.accordion[open] {
-      box-shadow: var(--shadow-soft);
-    }
-
-    details.accordion summary {
-      list-style: none;
-      cursor: pointer;
-      padding: 12px 14px;
-      display: flex;
-      align-items: center;
-      justify-content: space-between;
-      gap: 10px;
-      user-select: none;
-      background: var(--card);
-    }
-
-    details.accordion summary::-webkit-details-marker {
-      display: none;
-    }
-
-    .summary-title {
-      display: flex;
-      align-items: center;
-      gap: 10px;
-      min-width: 0;
-    }
-
-    .summary-title .k {
-      font-weight: 900;
-      font-size: 13px;
-      white-space: nowrap;
-      color: var(--ink);
-    }
-
-    .summary-title .d {
-      font-size: 12px;
-      color: var(--muted);
-      white-space: nowrap;
-      overflow: hidden;
-      text-overflow: ellipsis;
-    }
-
-    .chev {
-      width: 28px;
-      height: 28px;
-      border-radius: 10px;
-      display: grid;
-      place-items: center;
-      background: var(--soft);
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      flex: 0 0 auto;
-      font-weight: 900;
-      color: var(--ink);
-    }
-
-    details[open] .chev {
-      transform: rotate(90deg);
-    }
-
-    .accordion-body {
-      padding: 12px 14px 14px;
-      border-top: 1px solid rgba(203, 213, 225, 0.95);
-      background: var(--soft);
-    }
-
-    /* Parser result cards */
-    .results-layout {
-      display: grid;
-      grid-template-columns: repeat(3, minmax(0, 1fr));
-      gap: 12px;
-      margin-top: 12px;
-    }
-
-    @media (max-width: 1024px) {
-      .results-layout {
-        grid-template-columns: 1fr;
-      }
-    }
-
-    .result-column {
-      display: flex;
-      flex-direction: column;
-      gap: 8px;
-      min-width: 0;
-    }
-
-    .result-card {
-      background: var(--card);
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      border-radius: 10px;
-      padding: 10px;
-      cursor: pointer;
-      position: relative;
-      transition: transform .08s ease, box-shadow .08s ease;
-    }
-
-    .result-card:hover {
-      transform: translateY(-1px);
-      box-shadow: 0 12px 22px rgba(2, 6, 23, 0.08);
-    }
-
-    .result-title {
-      font-size: 12px;
-      font-weight: 900;
-      color: var(--ink);
-      opacity: .9;
-    }
-
-    .result-number {
-      font-family: ui-monospace, monospace;
-      font-size: 13px;
-      word-break: break-all;
-      margin-top: 6px;
-      color: var(--ink);
-    }
-
-    .count-badge {
-      position: absolute;
-      top: 10px;
-      right: 10px;
-      background: var(--ok);
-      color: var(--card);
-      border-radius: 999px;
-      padding: 2px 8px;
-      font-size: 11px;
-      font-weight: 900;
-      box-shadow: 0 8px 16px rgba(21, 128, 61, 0.18);
-    }
-
-    .result-card.main {
-      border-left: 4px solid var(--ok);
-    }
-
-    .result-card.sql {
-      border-left: 4px solid var(--info);
-    }
-
-    .result-card.num-csv {
-      border-left: 4px solid var(--blue);
-    }
-
-    .result-card.uuid-main {
-      border-left: 4px solid #6d28d9;
-    }
-
-    .result-card.uuid-sql {
-      border-left: 4px solid #be185d;
-    }
-
-    .result-card.uuid-csv {
-      border-left: 4px solid #ea580c;
-    }
-
-    .result-card.grz-main {
-      border-left: 4px solid var(--err);
-    }
-
-    .result-card.grz-sql {
-      border-left: 4px solid #b91c1c;
-    }
-
-    .result-card.grz-csv {
-      border-left: 4px solid #991b1b;
-    }
-
-    .status {
-      margin-top: 10px;
-      padding: 10px;
-      border-radius: 10px;
-      font-size: 13px;
-      font-weight: 900;
-      border: 1px solid rgba(203, 213, 225, 0.95);
-    }
-
-    .status.success {
-      background: rgba(21, 128, 61, .10);
-      color: var(--ok);
-      border-color: rgba(21, 128, 61, .22);
-    }
-
-    .status.error {
-      background: rgba(220, 38, 38, .10);
-      color: var(--err);
-      border-color: rgba(220, 38, 38, .22);
-    }
-
-    .debug {
-      margin-top: 8px;
-      border-radius: 10px;
-      padding: 10px;
-      background: #0b1220;
-      color: #e6eef9;
-      font-family: ui-monospace, monospace;
-      font-size: 12px;
-      border: 1px solid rgba(203, 213, 225, 0.18);
-    }
-
-    .query-button {
-      background: var(--blue);
-      color: var(--card);
-      border: 0;
-      padding: 9px 12px;
-      border-radius: 10px;
-      cursor: pointer;
-      font-weight: 900;
-      margin-top: 4px;
-    }
-
-    .db-results-container {
-      margin-top: 10px;
-      padding: 10px;
-      background: var(--card);
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      border-radius: 10px;
-    }
-
-    .db-results-table {
-      width: 100%;
-      border-collapse: collapse;
-      font-size: 12px;
-    }
-
-    .db-results-table th,
-    .db-results-table td {
-      border: 1px solid rgba(203, 213, 225, 0.95);
-      padding: 6px;
-      text-align: left;
-    }
-
-    .db-results-table th {
-      background: rgba(148, 163, 184, 0.12);
-    }
-
-    /* Logging (KEEP AS-IS) */
-    #previewBox,
-    #logBox {
-      margin-top: 12px;
-      border-radius: 8px;
-      padding: 10px;
-      background: #0b1220;
-      color: #e6eef9;
-      max-height: 260px;
-      overflow: auto;
-    }
-
-    .line {
-      padding: 6px;
-      border-radius: 6px;
-      margin-bottom: 6px;
-      font-family: monospace;
-      white-space: pre-wrap;
-    }
-
-    .line.ok {
-      background: rgba(21, 128, 61, 0.10);
-      color: var(--ok);
-      border: 1px solid rgba(21, 128, 61, 0.16);
-    }
-
-    .line.err {
-      background: rgba(220, 38, 38, 0.10);
-      color: var(--err);
-      border: 1px solid rgba(220, 38, 38, 0.16);
-    }
-
-    .line.info {
-      background: rgba(2, 132, 199, 0.10);
-      color: var(--info);
-      border: 1px solid rgba(2, 132, 199, 0.16);
-    }
-
-    /* Options list */
-    .optlist {
-      display: flex;
-      gap: 8px;
-      flex-direction: column;
-      padding: 10px 12px;
-      border: 1px dashed rgba(100, 116, 139, .55);
-      border-radius: 12px;
-      background: color-mix(in srgb, var(--card) 92%, transparent);
-    }
-
-    .optlist label {
-      margin-top: 0;
-      font-weight: 650;
-      color: var(--ink);
-    }
-
-    .footer {
-      margin-top: 12px;
-      font-size: 13px;
-      color: var(--muted);
-    }
-
-    /* Operation fields visibility */
-    .op-fields {
-      display: none;
-    }
-
-    .op-fields.active {
-      display: block;
-    }
-
-    /* Quick anchors */
-    .anchor {
-      display: inline-flex;
-      gap: 8px;
-      align-items: center;
-      font-size: 12px;
-      font-weight: 900;
-      color: var(--blue);
-      text-decoration: none;
-      padding: 6px 10px;
-      border-radius: 999px;
-      border: 1px solid color-mix(in srgb, var(--blue) 35%, transparent);
-      background: color-mix(in srgb, var(--blue) 14%, transparent);
-    }
-
-    .anchor:hover {
-      background: color-mix(in srgb, var(--blue) 20%, transparent);
-    }
-
-    /* границы унифицируем */
-    .card,
-    .step,
-    .result-card,
-    details.accordion,
-    .db-results-container,
-    .db-results-table th,
-    .db-results-table td {
-      border-color: var(--border);
-    }
-
-    /* инпуты/селекты/textarea — чтобы в dark не были белыми */
-    input[type=text],
-    select,
-    textarea {
-      background: var(--card);
-      color: var(--ink);
-      border-color: rgba(148, 163, 184, 0.35);
-    }
-
-    input[type=text]::placeholder,
-    textarea::placeholder {
-      color: rgba(148, 163, 184, 0.85);
-    }
-
-    /* topbar фон тоже от темы */
-    .topbar {
-      background: color-mix(in srgb, var(--card) 88%, transparent);
-      border-color: color-mix(in srgb, var(--border) 85%, transparent);
-    }
-
-    button.secondary {
-      background: color-mix(in srgb, var(--card) 70%, var(--muted) 10%);
-      color: var(--ink);
-      border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
-      box-shadow: 0 6px 14px rgba(2, 6, 23, 0.06);
-    }
-  </style>
-
-</head>
-
-<body>
-  <div class="shell">
-
-    <!-- Sticky top bar -->
-    <div class="topbar">
-      <div class="topbar-left">
-        <span class="pill info">Mode: <span id="modePill" class="badge">pay_type</span></span>
-        <span class="pill">Всего: <span id="total" class="badge">0</span></span>
-        <span class="pill ok">Успех: <span id="success" class="badge">0</span></span>
-        <span class="pill err">Ошибки: <span id="fail" class="badge">0</span></span>
-        <span class="pill">Прогресс: <span id="progress" class="badge">0/0</span></span>
-      </div>
-      <div class="topbar-right">
-        <button id="themeToggle" type="button" class="secondary" title="Переключить тему">🌙 Тема</button>
-        <a class="anchor" href="#sendSection">⤵️ К отправке</a>
-        <a class="anchor" href="#logsSection">⤵️ К логам</a>
-      </div>
-    </div>
-
-    <!-- Main header -->
-    <div class="card">
-      <h1>Bulk Sender Ultimate v6.2 — set_pay_type / grn+comment / pan-пожиратель / или велосипед который сварили в гараже из чего попало, а он взял и поехал</h1>
-      <div class="small-muted">
-        CSV должен содержать UUID (в любом столбце) или в текстовом поле UUID можно вставлять в любом формате —
-        инструмент
-        попробует распознать.
-      </div>
-
-      <div class="steps" style="margin-top:12px">
-        <div class="step"><span class="n">1</span><span class="t">Настройки</span></div>
-        <div class="step"><span class="n">2</span><span class="t">Тикет / Текст</span></div>
-        <div class="step"><span class="n">3</span><span class="t">Парсер</span></div>
-        <div class="step"><span class="n">4</span><span class="t">Операция</span></div>
-        <div class="step"><span class="n">5</span><span class="t">Импорт UUID</span></div>
-        <div class="step"><span class="n">6</span><span class="t">Отправка</span></div>
-        <div class="step"><span class="n">7</span><span class="t">БД / Периоды</span></div>
-      </div>
-    </div>
-
-    <!-- 1) Global settings -->
-    <details class="accordion" open id="settingsSection">
-      <summary>
-        <div class="summary-title">
-          <span class="k">⚙️ Глобальные настройки</span>
-          <span class="d">API + задержки + авторизации (вводится один раз)</span>
-        </div>
-        <span class="chev">›</span>
-      </summary>
-
-      <div class="accordion-body">
-        <div class="card soft" style="margin-bottom:12px">
-          <h2>API</h2>
-          <div class="row">
-            <div>
-              <label>Request URL</label>
-              <input id="url" type="text" value="http://10.2.201.200/api/ui/find-transactions/set_pay_type" />
-              <div class="hint">Обычно меняется редко — настрой один раз и работай.</div>
-            </div>
-
-            <div>
-              <label>HTTP method</label>
-              <select id="method">
-                <option>POST</option>
-                <option>PUT</option>
-                <option>PATCH</option>
-              </select>
-            </div>
-
-            <div>
-              <label>Authorization (Bearer ...)</label>
-              <input id="auth" type="text" placeholder="Bearer ..." />
-            </div>
-          </div>
-
-          <div class="row two" style="margin-top:6px">
-            <div>
-              <label>Delay между запросами (ms)</label>
-              <input id="delay" type="text" value="200" />
-              <div class="hint">Рекомендация: 200–500 мс, если API начинает “подплавляться”.</div>
-            </div>
-            <div>
-              <label style="opacity:.9">Примечание</label>
-              <div class="small">
-                Тут можно позже добавить timeout/retry/limit, если понадобится. Сейчас оставил минимально.
-              </div>
-            </div>
-          </div>
-        </div>
-
-        <div class="card soft">
-          <h2>GLPI</h2>
-          <div class="row">
-            <div>
-              <label>GLPI Cookie (x-glpi-cookie)</label>
-              <input id="glpiCookie" type="text" placeholder="PHPSESSID=...; glpi...=...">
-              <div class="hint">Cookie берём из браузера (DevTools → Application/Storage → Cookies →
-                techsupport.megatoll.ru)</div>
-            </div>
-            <div>
-              <label>Ticket base</label>
-              <input id="ticketBase" type="text" value="https://techsupport.megatoll.ru/front/ticket.form.php?id=" />
-              <div class="hint">Будет использовано для загрузки текста тикета.</div>
-            </div>
-            <div>
-              <label style="opacity:.9">Справка</label>
-              <div class="small">
-                Нужен доступ в GLPI (быть залогиненным в этом браузере). Cookie можно держать вверху и не трогать.
-              </div>
-            </div>
-          </div>
-        </div>
-      </div>
-    </details>
-
-    <!-- 2) Ticket/text source -->
-    <details class="accordion" open id="ticketTextSection">
-      <summary>
-        <div class="summary-title">
-          <span class="k">📥 Источник текста</span>
-          <span class="d">Загрузка тикета или вставка сырого текста</span>
-        </div>
-        <span class="chev">›</span>
-      </summary>
-
-      <div class="accordion-body">
-        <div class="row">
-          <div class="card soft">
-            <h2>Загрузка тикета</h2>
-            <label>Ticket ID</label>
-            <input id="ticketId" type="text" placeholder="11353" />
-            <div class="controls">
-              <button id="btnLoadTicket" type="button" class="secondary">📥 Загрузить текст тикета</button>
-              <span class="small">Берёт cookie из “Глобальные настройки → GLPI”.</span>
-            </div>
-          </div>
-
-          <div class="card soft" style="grid-column: span 2;">
-            <h2>📝 Текст для парсинга</h2>
-            <textarea id="inputText" placeholder="Вставьте сырой текст..."></textarea>
-            <div class="controls split">
-              <div class="btn-group">
-                <button id="btnTransferText" type="button" class="secondary">➡️ Перенести текст в Sender
-                  textarea</button>
-              </div>
-              <div class="small-muted">Можно вставлять любые форматы — парсер попробует вытащить
-                UUID/ГРНЗ/постановления.
-              </div>
-            </div>
-          </div>
-        </div>
-      </div>
-    </details>
-
-    <!-- 3) Parser -->
-    <details class="accordion" open id="parserSection">
-      <summary>
-        <div class="summary-title">
-          <span class="k">🔍 Парсер</span>
-          <span class="d">Результаты (постановления / UUID / ГРНЗ) + действия</span>
-        </div>
-        <span class="chev">›</span>
-      </summary>
-
-      <div class="accordion-body">
-        <!-- Keep original #result container + internal ids, only moved here -->
-        <div id="result" style="display:none;">
-          <div class="results-layout">
-            <div class="result-column">
-              <h3 style="color:#16a34a;">📜 Постановления</h3>
-              <div class="result-card main" id="cardNumMain" onclick="copyNumber()">
-                <div class="count-badge" id="mainCount">0</div>
-                <div class="result-title">📱 Номер постановления</div>
-                <div class="result-number" id="outputText"></div>
-              </div>
-              <div class="result-card sql" id="cardNumSql" onclick="copySQL()">
-                <div class="count-badge" id="sqlCount">0</div>
-                <div class="result-title">💾 SQL IN (...)</div>
-                <div class="result-number" id="sqlOutput"></div>
-              </div>
-              <div class="result-card num-csv" id="cardNumCsv" onclick="copyNumCsv()">
-                <div class="count-badge" id="numCsvCount">0</div>
-                <div class="result-title">📄 CSV</div>
-                <div class="result-number" id="numCsvOutput"></div>
-              </div>
-              <button id="queryDbBtn" class="query-button" style="display:none;">📡 Найти постановления в БД</button>
-            </div>
-
-            <div class="result-column">
-              <h3 style="color:#7c3aed;">🆔 UUID</h3>
-              <div class="result-card uuid-main" id="cardUuidMain" onclick="copyUUIDMain()">
-                <div class="count-badge" id="uuidMainCount">0</div>
-                <div class="result-title">🆔 UUID (главный)</div>
-                <div class="result-number" id="uuidOutput"></div>
-              </div>
-              <div class="controls">
-                <button id="btnUseParsedUuids" class="secondary" type="button">➡️ Использовать UUID в Sender</button>
-                <button id="btnFillGrnMode" class="secondary" type="button">⚙️ Подставить UUID + ГРНЗ в
-                  grn+comment</button>
-              </div>
-            </div>
-
-            <div class="result-column">
-              <h3 style="color:#ef4444;">🚗 ГРНЗ</h3>
-              <div class="result-card grz-main" id="cardGrzMain" onclick="copyGrzMain()">
-                <div class="count-badge" id="grzMainCount">0</div>
-                <div class="result-title">🚗 ГРНЗ (главный)</div>
-                <div class="result-number" id="grzOutput"></div>
-              </div>
-              <div class="result-card grz-sql" id="cardGrzSql" onclick="copyGrzSQL()">
-                <div class="count-badge" id="grzSqlCount">0</div>
-                <div class="result-title">💾 SQL IN (ГРНЗ)</div>
-                <div class="result-number" id="grzSqlOutput"></div>
-              </div>
-              <div class="result-card grz-csv" id="cardGrzCsv" onclick="copyGrzCsv()">
-                <div class="count-badge" id="grzCsvCount">0</div>
-                <div class="result-title">📄 CSV ГРНЗ</div>
-                <div class="result-number" id="grzCsvOutput"></div>
-              </div>
-            </div>
-          </div>
-
-          <div id="status" class="status"></div>
-          <div id="debug" class="debug"></div>
-
-          <div id="dbResultsContainer" class="db-results-container" style="display:none;">
-            <h3>Результаты из БД</h3>
-            <div id="dbResultsOutput"></div>
-          </div>
-        </div>
-
-        <div class="small-muted">
-          Если блок парсера пуст — вставь текст в “Источник текста” и запусти парсер (JS модуль сделает остальное).
-        </div>
-      </div>
-    </details>
-
-    <!-- 4) Operation -->
-    <details class="accordion" open id="operationSection">
-      <summary>
-        <div class="summary-title">
-          <span class="k">🧩 Операция</span>
-          <span class="d">Выбор режима + поля только выбранной операции</span>
-        </div>
-        <span class="chev">›</span>
-      </summary>
-
-      <div class="accordion-body">
-        <div class="row">
-          <div class="card soft">
-            <h2>Operation mode</h2>
-            <label>Режим</label>
-            <select id="mode" class="highlight-select">
-              <option value="pay_type">Сменить pay_type (body: { transaction_uuid, pay_type })</option>
-              <option value="grn_comment">Отправить grn + comment (body: { transaction_uuid, grn, comment })</option>
-              <option value="pan_change">Сменить PAN (парсинг из текста) (body: { transaction_uuid, grn, comment })
-              </option>
-            </select>
-            <div class="hint">Ниже появятся только поля, которые нужны выбранному режиму.</div>
-          </div>
-
-          <div class="card soft" style="grid-column: span 2;">
-            <h2>Поля операции</h2>
-
-            <!-- pay_type fields -->
-            <div id="fields_pay_type" class="op-fields">
-              <div class="row two">
-                <div>
-                  <label>Pay type</label>
-                  <input id="payType" type="text" value="5" />
-                  <div class="hint">Используется только в режиме смены pay_type.</div>
-                </div>
-                <div>
-                  <label style="opacity:.9">Справка</label>
-                  <div class="small">Тело запроса: <b>{ transaction_uuid, pay_type }</b></div>
-                </div>
-              </div>
-            </div>
-
-            <!-- grn_comment fields -->
-            <div id="fields_grn_comment" class="op-fields">
-              <div class="row">
-                <div>
-                  <label>GRN</label>
-                  <input id="grn" type="text" placeholder="например T732YE797" />
-                </div>
-                <div>
-                  <label>COMMENT</label>
-                  <input id="comment" type="text" placeholder="например 8667" />
-                </div>
-                <div>
-                  <label style="opacity:.9">Справка</label>
-                  <div class="small">Тело запроса: <b>{ transaction_uuid, grn, comment }</b></div>
-                </div>
-              </div>
-            </div>
-
-            <!-- pan_change fields -->
-            <div id="fields_pan_change" class="op-fields">
-              <div class="row one">
-                <div>
-                  <div class="small-muted">
-                    Режим PAN: парсинг идёт из текста обращения. Обычно используется связка <b>transaction_uuid + grn +
-                      comment</b> (как в grn_comment).
-                    <br />Если у тебя есть отдельное поле для PAN — добавь сюда, и в JS сформируй body.
-                  </div>
-                </div>
-              </div>
-
-              <!-- оставляем те же поля grn/comment (они нужны и для pan_change по твоему описанию) -->
-              <div class="row">
-                <div>
-                  <label>GRN</label>
-                  <input id="grn_pan_mirror" type="text"
-                    placeholder="например T732YE797 (можно оставить пустым, если берёшь из парсера)" />
-                  <div class="hint">Это зеркало, чтобы не мешать основным id. Если хочешь — убери и используй
-                    #grn/#comment.</div>
-                </div>
-                <div>
-                  <label>COMMENT</label>
-                  <input id="comment_pan_mirror" type="text" placeholder="например 8667" />
-                </div>
-                <div>
-                  <label style="opacity:.9">Справка</label>
-                  <div class="small">Тело запроса (как сейчас): <b>{ transaction_uuid, grn, comment }</b></div>
-                </div>
-              </div>
-            </div>
-
-            <div class="hint">Примечание: для совместимости с текущим JS, базовые поля оставлены с теми же id (#payType,
-              #grn, #comment).</div>
-          </div>
-        </div>
-      </div>
-    </details>
-
-    <!-- 5) Import UUID -->
-    <details class="accordion" open id="importSection">
-      <summary>
-        <div class="summary-title">
-          <span class="k">📄 Импорт UUID</span>
-          <span class="d">Файл / textarea + правила извлечения</span>
-        </div>
-        <span class="chev">›</span>
-      </summary>
-
-      <div class="accordion-body">
-        <div class="row">
-          <div class="card soft">
-            <h2>Источник UUID</h2>
-            <label>Источник</label>
-            <select id="source" class="highlight-select">
-              <option value="file">CSV / TXT файл</option>
-              <option value="textarea">Поле ввода (textarea)</option>
-            </select>
-
-            <label style="margin-top:10px">CSV / TXT файл</label>
-            <input id="csvFile" type="file" accept=".csv,.txt" />
-            <div class="hint">Можно таблицу с колонками или просто список UUID в строках.</div>
-          </div>
-
-          <div class="card soft">
-            <h2>Ручной ввод UUID / CSV</h2>
-            <label>Textarea</label>
-            <textarea id="textArea" placeholder="uuid1\nuuid2\nили transaction_uuid,grn,..."></textarea>
-            <div class="hint">Разделители: переносы строки, запятая, ;, пробелы, табы. Header тоже поддерживается.</div>
-          </div>
-
-          <div class="card soft">
-            <h2>Опции импорта</h2>
-
-            <label>UUID column name (если в CSV header)</label>
-            <input id="uuidCol" type="text" placeholder="transaction_uuid (опционально)" />
-            <div class="hint">Если CSV имеет header — укажи имя столбца; иначе система попробует найти UUID
-              автоматически.
-            </div>
-
-            <div class="optlist" style="margin-top:10px">
-              <label><input id="fastExtract" type="checkbox" checked /> Быстрое извлечение UUID из любого текста
-                (например
-                smena-pan.txt)</label>
-              <label><input id="useFirstColIfHeader" type="checkbox" checked /> Если header не указан — брать первую
-                колонку</label>
-              <label><input id="skipPreview" type="checkbox" /> Пропускать Preview перед Send All (не
-                рекомендовано)</label>
-              <label><input id="autoDownloadErrors" type="checkbox" /> Скачать errors.csv автоматически</label>
-              <label><input id="autoClosePeriods" type="checkbox" /> Автозакрытие периодов после успешной
-                отправки</label>
-            </div>
-          </div>
-        </div>
-      </div>
-    </details>
-
-    <!-- 6) Sending -->
-    <details class="accordion" open id="sendSection">
-      <summary>
-        <div class="summary-title">
-          <span class="k">🚀 Отправка</span>
-          <span class="d">Preview → Send 1 → Send All + отчёты</span>
-        </div>
-        <span class="chev">›</span>
-      </summary>
-
-      <div class="accordion-body">
-        <div class="card soft">
-          <div class="controls split">
-            <div class="btn-group">
-              <button id="btnPreview">Preview (первые 10)</button>
-              <button id="btnSendOne" class="secondary">Send 1 (тест)</button>
-            </div>
-
-            <div class="btn-group">
-              <button id="btnSendAll">Send All</button>
-              <button id="btnPause" class="secondary" disabled>Pause</button>
-              <button id="btnStop" class="warn" disabled>Stop</button>
-            </div>
-
-            <div class="btn-group">
-              <button id="btnDownloadErrors" class="secondary">Скачать errors.csv</button>
-              <button id="btnDownloadReport" class="secondary">Скачать report.csv</button>
-            </div>
-          </div>
-
-          <div class="small-muted" style="margin-top:10px">
-            Совет: Preview → Send 1 → Send All
-          </div>
-
-          <h3 style="margin-top:14px">PREVIEW</h3>
-          <div id="previewBox"></div>
-
-          <div class="footer">
-            <div class="hint">Поддерживаемые форматы в textarea: простые строки UUID, CSV с header, разделители:
-              запятая,
-              ;, пробелы, табы, переносы строки.</div>
-          </div>
-        </div>
-      </div>
-    </details>
-
-    <!-- 7) DB & periods -->
-    <details class="accordion" open id="dbSection">
-      <summary>
-        <div class="summary-title">
-          <span class="k">🗄️ БД / Периоды</span>
-          <span class="d">Поиск/результаты и SQL открыть/закрыть периоды</span>
-        </div>
-        <span class="chev">›</span>
-      </summary>
-
-      <div class="accordion-body">
-        <div class="row two">
-          <div class="card soft">
-            <h2>Периоды</h2>
-            <div class="controls">
-              <button id="btnOpenPeriods" class="secondary">Открыть периоды (SQL)</button>
-              <button id="btnClosePeriods" class="secondary">Закрыть периоды (SQL)</button>
-            </div>
-            <div class="hint">Обычно это вспомогательные команды — держим рядом с БД.</div>
-          </div>
-
-          <div class="card soft">
-            <h2>Поиск в БД</h2>
-            <div class="small-muted">
-              Кнопка “📡 Найти постановления в БД” показывается парсером при необходимости (id сохранён: #queryDbBtn).
-            </div>
-            <div class="hint">Результаты появятся в блоке парсера (таблица) — id сохранён.</div>
-          </div>
-        </div>
-      </div>
-    </details>
-
-    <!-- 8) Logs (UNCHANGED) -->
-    <details class="accordion" open id="logsSection">
-      <summary>
-        <div class="summary-title">
-          <span class="k">🧾 Логи</span>
-          <span class="d">Оставлено без изменений</span>
-        </div>
-        <span class="chev">›</span>
-      </summary>
-
-      <div class="accordion-body">
-        <h3>Логи</h3>
-        <div id="logBox"></div>
-      </div>
-    </details>
-
-  </div>
-
-  <!-- Small helper: show/hide operation fields based on #mode -->
-  <script>
-    (function () {
-      const mode = document.getElementById('mode');
-      const pill = document.getElementById('modePill');
-
-      const blocks = {
-        pay_type: document.getElementById('fields_pay_type'),
-        grn_comment: document.getElementById('fields_grn_comment'),
-        pan_change: document.getElementById('fields_pan_change')
-      };
-
-      function applyMode() {
-        const v = mode?.value || 'pay_type';
-        if (pill) pill.textContent = v;
-        Object.keys(blocks).forEach(k => {
-          if (!blocks[k]) return;
-          blocks[k].classList.toggle('active', k === v);
-        });
-      }
-
-      if (mode) {
-        mode.addEventListener('change', applyMode);
-        applyMode();
-      }
-    })();
-  </script>
-
-  <!-- Your existing modules -->
-  <script src="js-bs-6/tema.js"></script>
-  <script type="module" src="js-bs-6/main.js"></script>
-  <script type="module" src="js-bs-6/parser/main.js"></script>
-  <script type="module" src="js-bs-6/ticket_parser.js"></script>
-
-</body>
-
+<!doctype html>
+<html lang="ru">
+
+<head>
+  <meta charset="utf-8" />
+  <meta name="viewport" content="width=device-width,initial-scale=1" />
+  <title>Bulk Sender Ultimate v6.2</title>
+  <link rel="icon" type="image/png" href="velik.png">
+
+  <style>
+    :root {
+      /* LIGHT (default) */
+      --bg: #e9eef6;
+      --card: #ffffff;
+      --muted: #475569;
+      --ok: #15803d;
+      --err: #dc2626;
+      --info: #0284c7;
+      --ink: #0b1220;
+      --border: #cbd5e1;
+      --soft: #eef2f7;
+      --blue: #1d4ed8;
+
+      --shadow: 0 10px 28px rgba(2, 6, 23, 0.10);
+      --shadow-soft: 0 6px 18px rgba(2, 6, 23, 0.08);
+      --ring: 0 0 0 4px rgba(29, 78, 216, 0.16);
+    }
+
+    /* DARK */
+    html[data-theme="dark"] {
+      --bg: #0b1220;
+      /* общий фон */
+      --card: #0f172a;
+      /* карточки */
+      --soft: #0b1324;
+      /* “soft” блоки */
+      --ink: #e5e7eb;
+      /* основной текст */
+      --muted: #94a3b8;
+      /* вторичный текст */
+      --border: #263244;
+      /* границы */
+
+      --blue: #3b82f6;
+      /* акцент */
+      --ok: #22c55e;
+      --err: #f87171;
+      --info: #38bdf8;
+
+      --shadow: 0 14px 34px rgba(0, 0, 0, 0.40);
+      --shadow-soft: 0 10px 22px rgba(0, 0, 0, 0.28);
+      --ring: 0 0 0 4px rgba(59, 130, 246, 0.22);
+    }
+
+
+    * {
+      box-sizing: border-box
+    }
+
+    body {
+      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
+      margin: 18px;
+      background: var(--bg);
+      color: var(--ink);
+    }
+
+    /* Layout shell */
+    .shell {
+      max-width: 1200px;
+      margin: 0 auto;
+      display: grid;
+      grid-template-columns: 1fr;
+      gap: 12px;
+    }
+
+    .card {
+      padding: 16px;
+      border-radius: 12px;
+      background: var(--card);
+      box-shadow: var(--shadow-soft);
+      border: 1px solid rgba(203, 213, 225, 0.9);
+    }
+
+    .card.soft {
+      background: var(--soft);
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      box-shadow: none;
+    }
+
+    h1 {
+      font-size: 18px;
+      margin: 0 0 8px;
+      line-height: 1.25;
+    }
+
+    h2 {
+      font-size: 15px;
+      margin: 0 0 8px;
+      line-height: 1.25;
+    }
+
+    h1,
+    h2 {
+      color: var(--ink);
+    }
+
+    h3 {
+      font-size: 13px;
+      margin: 0 0 8px;
+      line-height: 1.25;
+      color: var(--ink);
+      opacity: .9;
+    }
+
+    .small {
+      font-size: 12px;
+      color: var(--muted);
+    }
+
+    .small-muted {
+      font-size: 12px;
+      color: var(--muted);
+    }
+
+    .hint {
+      font-size: 12px;
+      color: var(--muted);
+      margin-top: 6px;
+    }
+
+    /* Sticky top bar */
+    .topbar {
+      position: sticky;
+      top: 10px;
+      z-index: 20;
+      padding: 10px 12px;
+      border-radius: 12px;
+      display: flex;
+      gap: 10px;
+      align-items: center;
+      justify-content: space-between;
+
+      background: rgba(255, 255, 255, 0.92);
+      backdrop-filter: blur(10px);
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      box-shadow: var(--shadow);
+    }
+
+    .topbar-left {
+      display: flex;
+      gap: 8px;
+      align-items: center;
+      flex-wrap: wrap;
+      min-width: 0;
+    }
+
+    .topbar-right {
+      display: flex;
+      gap: 8px;
+      align-items: center;
+      flex-wrap: wrap;
+    }
+
+    .pill {
+      padding: 6px 10px;
+      border-radius: 999px;
+      background: var(--soft);
+      /* darker chip */
+      font-weight: 800;
+      font-size: 12px;
+      display: inline-flex;
+      gap: 6px;
+      align-items: center;
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      color: var(--ink);
+    }
+
+    .pill.ok {
+      background: rgba(21, 128, 61, 0.14);
+      border-color: rgba(21, 128, 61, 0.24);
+      color: var(--ok);
+    }
+
+    .pill.err {
+      background: rgba(220, 38, 38, 0.14);
+      border-color: rgba(220, 38, 38, 0.24);
+      color: var(--err);
+    }
+
+    .pill.info {
+      background: rgba(2, 132, 199, 0.14);
+      border-color: rgba(2, 132, 199, 0.24);
+      color: var(--info);
+    }
+
+    .badge {
+      font-weight: 900;
+    }
+
+    .spacer {
+      flex: 1;
+      min-width: 10px;
+    }
+
+    /* Stepper */
+    .steps {
+      display: grid;
+      grid-template-columns: repeat(7, minmax(0, 1fr));
+      gap: 8px;
+      margin-top: 8px;
+    }
+
+    .step {
+      padding: 10px;
+      border-radius: 10px;
+      background: var(--card);
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      display: flex;
+      gap: 10px;
+      align-items: center;
+      min-width: 0;
+      box-shadow: 0 4px 10px rgba(2, 6, 23, 0.05);
+    }
+
+    .step .n {
+      width: 22px;
+      height: 22px;
+      border-radius: 999px;
+      background: rgba(29, 78, 216, 0.14);
+      color: #1d4ed8;
+      font-weight: 900;
+      display: grid;
+      place-items: center;
+      flex: 0 0 auto;
+      border: 1px solid rgba(29, 78, 216, 0.26);
+      font-size: 12px;
+    }
+
+    .step .t {
+      font-size: 12px;
+      font-weight: 900;
+      color: var(--ink);
+      white-space: nowrap;
+      overflow: hidden;
+      text-overflow: ellipsis;
+    }
+
+    @media (max-width: 1100px) {
+      .steps {
+        grid-template-columns: repeat(3, minmax(0, 1fr));
+      }
+    }
+
+    @media (max-width: 680px) {
+      .steps {
+        grid-template-columns: repeat(2, minmax(0, 1fr));
+      }
+    }
+
+    /* Forms */
+    label {
+      display: block;
+      font-size: 13px;
+      color: var(--ink);
+      margin-top: 8px;
+      font-weight: 700;
+    }
+
+    input[type=text],
+    select,
+    textarea {
+      width: 100%;
+      padding: 9px 10px;
+      border: 1px solid rgba(148, 163, 184, 0.7);
+      /* darker than #e6e9ef */
+      border-radius: 10px;
+      font-size: 14px;
+      outline: none;
+      background: var(--card);
+      color: var(--ink);
+    }
+
+    input[type=text]:focus,
+    select:focus,
+    textarea:focus {
+      border-color: rgba(29, 78, 216, 0.65);
+      box-shadow: var(--ring);
+    }
+
+    textarea {
+      min-height: 70px;
+      resize: vertical;
+    }
+
+    input[type=file] {
+      margin-top: 8px;
+    }
+
+    .highlight-select {
+      border: 2px solid rgba(29, 78, 216, 0.65);
+      background: rgba(29, 78, 216, 0.08);
+      padding: 7px 8px;
+      border-radius: 10px;
+      transition: 0.25s ease;
+      font-weight: 900;
+    }
+
+    .row {
+      display: grid;
+      grid-template-columns: repeat(3, minmax(0, 1fr));
+      gap: 12px;
+      align-items: start;
+    }
+
+    .row.two {
+      grid-template-columns: repeat(2, minmax(0, 1fr));
+    }
+
+    .row.one {
+      grid-template-columns: 1fr;
+    }
+
+    @media (max-width: 1024px) {
+
+      .row,
+      .row.two {
+        grid-template-columns: 1fr;
+      }
+    }
+
+    /* Buttons */
+    button {
+      background: var(--blue);
+      color: var(--card);
+      border: 0;
+      padding: 9px 12px;
+      border-radius: 10px;
+      cursor: pointer;
+      font-weight: 900;
+      font-size: 13px;
+      box-shadow: 0 6px 14px rgba(29, 78, 216, 0.18);
+    }
+
+    button:hover {
+      filter: brightness(0.98);
+    }
+
+    button.secondary {
+      background: #dbe3ee;
+      color: #0b1220;
+      box-shadow: 0 6px 14px rgba(2, 6, 23, 0.06);
+    }
+
+    button.warn {
+      background: var(--err);
+      color: var(--card);
+      box-shadow: 0 6px 14px rgba(220, 38, 38, 0.16);
+    }
+
+    button:disabled {
+      opacity: .6;
+      cursor: not-allowed;
+      box-shadow: none;
+    }
+
+    .controls {
+      display: flex;
+      gap: 8px;
+      align-items: center;
+      margin-top: 12px;
+      flex-wrap: wrap;
+    }
+
+    .controls.split {
+      justify-content: space-between;
+    }
+
+    .btn-group {
+      display: flex;
+      gap: 8px;
+      flex-wrap: wrap;
+    }
+
+    /* Sections / Accordions */
+    details.accordion {
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      border-radius: 12px;
+      background: var(--card);
+      overflow: hidden;
+    }
+
+    details.accordion[open] {
+      box-shadow: var(--shadow-soft);
+    }
+
+    details.accordion summary {
+      list-style: none;
+      cursor: pointer;
+      padding: 12px 14px;
+      display: flex;
+      align-items: center;
+      justify-content: space-between;
+      gap: 10px;
+      user-select: none;
+      background: var(--card);
+    }
+
+    details.accordion summary::-webkit-details-marker {
+      display: none;
+    }
+
+    .summary-title {
+      display: flex;
+      align-items: center;
+      gap: 10px;
+      min-width: 0;
+    }
+
+    .summary-title .k {
+      font-weight: 900;
+      font-size: 13px;
+      white-space: nowrap;
+      color: var(--ink);
+    }
+
+    .summary-title .d {
+      font-size: 12px;
+      color: var(--muted);
+      white-space: nowrap;
+      overflow: hidden;
+      text-overflow: ellipsis;
+    }
+
+    .chev {
+      width: 28px;
+      height: 28px;
+      border-radius: 10px;
+      display: grid;
+      place-items: center;
+      background: var(--soft);
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      flex: 0 0 auto;
+      font-weight: 900;
+      color: var(--ink);
+    }
+
+    details[open] .chev {
+      transform: rotate(90deg);
+    }
+
+    .accordion-body {
+      padding: 12px 14px 14px;
+      border-top: 1px solid rgba(203, 213, 225, 0.95);
+      background: var(--soft);
+    }
+
+    /* Parser result cards */
+    .results-layout {
+      display: grid;
+      grid-template-columns: repeat(3, minmax(0, 1fr));
+      gap: 12px;
+      margin-top: 12px;
+    }
+
+    @media (max-width: 1024px) {
+      .results-layout {
+        grid-template-columns: 1fr;
+      }
+    }
+
+    .result-column {
+      display: flex;
+      flex-direction: column;
+      gap: 8px;
+      min-width: 0;
+    }
+
+    .result-card {
+      background: var(--card);
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      border-radius: 10px;
+      padding: 10px;
+      cursor: pointer;
+      position: relative;
+      transition: transform .08s ease, box-shadow .08s ease;
+    }
+
+    .result-card:hover {
+      transform: translateY(-1px);
+      box-shadow: 0 12px 22px rgba(2, 6, 23, 0.08);
+    }
+
+    .result-title {
+      font-size: 12px;
+      font-weight: 900;
+      color: var(--ink);
+      opacity: .9;
+    }
+
+    .result-number {
+      font-family: ui-monospace, monospace;
+      font-size: 13px;
+      word-break: break-all;
+      margin-top: 6px;
+      color: var(--ink);
+    }
+
+    .count-badge {
+      position: absolute;
+      top: 10px;
+      right: 10px;
+      background: var(--ok);
+      color: var(--card);
+      border-radius: 999px;
+      padding: 2px 8px;
+      font-size: 11px;
+      font-weight: 900;
+      box-shadow: 0 8px 16px rgba(21, 128, 61, 0.18);
+    }
+
+    .result-card.main {
+      border-left: 4px solid var(--ok);
+    }
+
+    .result-card.sql {
+      border-left: 4px solid var(--info);
+    }
+
+    .result-card.num-csv {
+      border-left: 4px solid var(--blue);
+    }
+
+    .result-card.uuid-main {
+      border-left: 4px solid #6d28d9;
+    }
+
+    .result-card.uuid-sql {
+      border-left: 4px solid #be185d;
+    }
+
+    .result-card.uuid-csv {
+      border-left: 4px solid #ea580c;
+    }
+
+    .result-card.grz-main {
+      border-left: 4px solid var(--err);
+    }
+
+    .result-card.grz-sql {
+      border-left: 4px solid #b91c1c;
+    }
+
+    .result-card.grz-csv {
+      border-left: 4px solid #991b1b;
+    }
+
+    .status {
+      margin-top: 10px;
+      padding: 10px;
+      border-radius: 10px;
+      font-size: 13px;
+      font-weight: 900;
+      border: 1px solid rgba(203, 213, 225, 0.95);
+    }
+
+    .status.success {
+      background: rgba(21, 128, 61, .10);
+      color: var(--ok);
+      border-color: rgba(21, 128, 61, .22);
+    }
+
+    .status.error {
+      background: rgba(220, 38, 38, .10);
+      color: var(--err);
+      border-color: rgba(220, 38, 38, .22);
+    }
+
+    .debug {
+      margin-top: 8px;
+      border-radius: 10px;
+      padding: 10px;
+      background: #0b1220;
+      color: #e6eef9;
+      font-family: ui-monospace, monospace;
+      font-size: 12px;
+      border: 1px solid rgba(203, 213, 225, 0.18);
+    }
+
+    .query-button {
+      background: var(--blue);
+      color: var(--card);
+      border: 0;
+      padding: 9px 12px;
+      border-radius: 10px;
+      cursor: pointer;
+      font-weight: 900;
+      margin-top: 4px;
+    }
+
+    .db-results-container {
+      margin-top: 10px;
+      padding: 10px;
+      background: var(--card);
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      border-radius: 10px;
+    }
+
+    .db-results-table {
+      width: 100%;
+      border-collapse: collapse;
+      font-size: 12px;
+    }
+
+    .db-results-table th,
+    .db-results-table td {
+      border: 1px solid rgba(203, 213, 225, 0.95);
+      padding: 6px;
+      text-align: left;
+    }
+
+    .db-results-table th {
+      background: rgba(148, 163, 184, 0.12);
+    }
+
+    /* Logging (KEEP AS-IS) */
+    #previewBox,
+    #logBox {
+      margin-top: 12px;
+      border-radius: 8px;
+      padding: 10px;
+      background: #0b1220;
+      color: #e6eef9;
+      max-height: 260px;
+      overflow: auto;
+    }
+
+    .line {
+      padding: 6px;
+      border-radius: 6px;
+      margin-bottom: 6px;
+      font-family: monospace;
+      white-space: pre-wrap;
+    }
+
+    .line.ok {
+      background: rgba(21, 128, 61, 0.10);
+      color: var(--ok);
+      border: 1px solid rgba(21, 128, 61, 0.16);
+    }
+
+    .line.err {
+      background: rgba(220, 38, 38, 0.10);
+      color: var(--err);
+      border: 1px solid rgba(220, 38, 38, 0.16);
+    }
+
+    .line.info {
+      background: rgba(2, 132, 199, 0.10);
+      color: var(--info);
+      border: 1px solid rgba(2, 132, 199, 0.16);
+    }
+
+    /* Options list */
+    .optlist {
+      display: flex;
+      gap: 8px;
+      flex-direction: column;
+      padding: 10px 12px;
+      border: 1px dashed rgba(100, 116, 139, .55);
+      border-radius: 12px;
+      background: color-mix(in srgb, var(--card) 92%, transparent);
+    }
+
+    .optlist label {
+      margin-top: 0;
+      font-weight: 650;
+      color: var(--ink);
+    }
+
+    .footer {
+      margin-top: 12px;
+      font-size: 13px;
+      color: var(--muted);
+    }
+
+    /* Operation fields visibility */
+    .op-fields {
+      display: none;
+    }
+
+    .op-fields.active {
+      display: block;
+    }
+
+    /* Quick anchors */
+    .anchor {
+      display: inline-flex;
+      gap: 8px;
+      align-items: center;
+      font-size: 12px;
+      font-weight: 900;
+      color: var(--blue);
+      text-decoration: none;
+      padding: 6px 10px;
+      border-radius: 999px;
+      border: 1px solid color-mix(in srgb, var(--blue) 35%, transparent);
+      background: color-mix(in srgb, var(--blue) 14%, transparent);
+    }
+
+    .anchor:hover {
+      background: color-mix(in srgb, var(--blue) 20%, transparent);
+    }
+
+    /* границы унифицируем */
+    .card,
+    .step,
+    .result-card,
+    details.accordion,
+    .db-results-container,
+    .db-results-table th,
+    .db-results-table td {
+      border-color: var(--border);
+    }
+
+    /* инпуты/селекты/textarea — чтобы в dark не были белыми */
+    input[type=text],
+    select,
+    textarea {
+      background: var(--card);
+      color: var(--ink);
+      border-color: rgba(148, 163, 184, 0.35);
+    }
+
+    input[type=text]::placeholder,
+    textarea::placeholder {
+      color: rgba(148, 163, 184, 0.85);
+    }
+
+    /* topbar фон тоже от темы */
+    .topbar {
+      background: color-mix(in srgb, var(--card) 88%, transparent);
+      border-color: color-mix(in srgb, var(--border) 85%, transparent);
+    }
+
+    button.secondary {
+      background: color-mix(in srgb, var(--card) 70%, var(--muted) 10%);
+      color: var(--ink);
+      border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
+      box-shadow: 0 6px 14px rgba(2, 6, 23, 0.06);
+    }
+  </style>
+
+</head>
+
+<body>
+  <div class="shell">
+
+    <!-- Sticky top bar -->
+    <div class="topbar">
+      <div class="topbar-left">
+        <span class="pill info">Mode: <span id="modePill" class="badge">pay_type</span></span>
+        <span class="pill">Всего: <span id="total" class="badge">0</span></span>
+        <span class="pill ok">Успех: <span id="success" class="badge">0</span></span>
+        <span class="pill err">Ошибки: <span id="fail" class="badge">0</span></span>
+        <span class="pill">Прогресс: <span id="progress" class="badge">0/0</span></span>
+      </div>
+      <div class="topbar-right">
+        <button id="themeToggle" type="button" class="secondary" title="Переключить тему">🌙 Тема</button>
+        <label style="display:flex;align-items:center;gap:8px;font-size:12px;font-weight:800;color:var(--muted)">
+          Режим
+          <select id="modeSidebar" class="highlight-select" style="min-width:180px;height:34px;padding:4px 10px;">
+            <option value="pay_type">pay_type</option>
+            <option value="class_change">class_change</option>
+            <option value="grn_comment">grn_comment</option>
+            <option value="pan_change">pan_change</option>
+          </select>
+        </label>
+        <a class="anchor" href="#sendSection">⤵️ К отправке</a>
+        <a class="anchor" href="#logsSection">⤵️ К логам</a>
+      </div>
+    </div>
+
+    <!-- Main header -->
+    <div class="card">
+      <h1>Bulk Sender Ultimate v6.2 — set_pay_type / grn+comment / pan-пожиратель / или велосипед который сварили в гараже из чего попало, а он взял и поехал</h1>
+      <div class="small-muted">
+        CSV должен содержать UUID (в любом столбце) или в текстовом поле UUID можно вставлять в любом формате —
+        инструмент
+        попробует распознать.
+      </div>
+
+      <div class="steps" style="margin-top:12px">
+        <div class="step"><span class="n">1</span><span class="t">Настройки</span></div>
+        <div class="step"><span class="n">2</span><span class="t">Тикет / Текст</span></div>
+        <div class="step"><span class="n">3</span><span class="t">Парсер</span></div>
+        <div class="step"><span class="n">4</span><span class="t">Операция</span></div>
+        <div class="step"><span class="n">5</span><span class="t">Импорт UUID</span></div>
+        <div class="step"><span class="n">6</span><span class="t">Отправка</span></div>
+        <div class="step"><span class="n">7</span><span class="t">БД / Периоды</span></div>
+      </div>
+    </div>
+
+    <!-- 1) Global settings -->
+    <details class="accordion" open id="settingsSection">
+      <summary>
+        <div class="summary-title">
+          <span class="k">⚙️ Глобальные настройки</span>
+          <span class="d">API + задержки + авторизации (вводится один раз)</span>
+        </div>
+        <span class="chev">›</span>
+      </summary>
+
+      <div class="accordion-body">
+        <div class="card soft" style="margin-bottom:12px">
+          <h2>API</h2>
+          <div class="row">
+            <div>
+              <label>Request URL</label>
+              <input id="url" type="text" value="http://10.2.201.200/api/ui/find-transactions/set_pay_type" />
+              <div class="hint">Обычно меняется редко — настрой один раз и работай.</div>
+            </div>
+
+            <div>
+              <label>HTTP method</label>
+              <select id="method">
+                <option>POST</option>
+                <option>PUT</option>
+                <option>PATCH</option>
+              </select>
+            </div>
+
+            <div>
+              <label>Authorization (Bearer ...)</label>
+              <input id="auth" type="text" placeholder="Bearer ..." />
+            </div>
+          </div>
+
+          <div class="row two" style="margin-top:6px">
+            <div>
+              <label>Delay между запросами (ms)</label>
+              <input id="delay" type="text" value="200" />
+              <div class="hint">Рекомендация: 200–500 мс, если API начинает “подплавляться”.</div>
+            </div>
+            <div>
+              <label style="opacity:.9">Примечание</label>
+              <div class="small">
+                Тут можно позже добавить timeout/retry/limit, если понадобится. Сейчас оставил минимально.
+              </div>
+            </div>
+          </div>
+        </div>
+
+        <div class="card soft">
+          <h2>GLPI</h2>
+          <div class="row">
+            <div>
+              <label>GLPI Cookie (x-glpi-cookie)</label>
+              <input id="glpiCookie" type="text" placeholder="PHPSESSID=...; glpi...=...">
+              <div class="hint">Cookie берём из браузера (DevTools → Application/Storage → Cookies →
+                techsupport.megatoll.ru)</div>
+            </div>
+            <div>
+              <label>Ticket base</label>
+              <input id="ticketBase" type="text" value="https://techsupport.megatoll.ru/front/ticket.form.php?id=" />
+              <div class="hint">Будет использовано для загрузки текста тикета.</div>
+            </div>
+            <div>
+              <label style="opacity:.9">Справка</label>
+              <div class="small">
+                Нужен доступ в GLPI (быть залогиненным в этом браузере). Cookie можно держать вверху и не трогать.
+              </div>
+            </div>
+          </div>
+        </div>
+      </div>
+    </details>
+
+    <!-- 2) Ticket/text source -->
+    <details class="accordion" open id="ticketTextSection">
+      <summary>
+        <div class="summary-title">
+          <span class="k">📥 Источник текста</span>
+          <span class="d">Загрузка тикета или вставка сырого текста</span>
+        </div>
+        <span class="chev">›</span>
+      </summary>
+
+      <div class="accordion-body">
+        <div class="row">
+          <div class="card soft">
+            <h2>Загрузка тикета</h2>
+            <label>Ticket ID</label>
+            <input id="ticketId" type="text" placeholder="11353" />
+            <div class="controls">
+              <button id="btnLoadTicket" type="button" class="secondary">📥 Загрузить текст тикета</button>
+              <span class="small">Берёт cookie из “Глобальные настройки → GLPI”.</span>
+            </div>
+          </div>
+
+          <div class="card soft" style="grid-column: span 2;">
+            <h2>📝 Текст для парсинга</h2>
+            <textarea id="inputText" placeholder="Вставьте сырой текст..."></textarea>
+            <div class="controls split">
+              <div class="btn-group">
+                <button id="btnTransferText" type="button" class="secondary">➡️ Перенести текст в Sender
+                  textarea</button>
+              </div>
+              <div class="small-muted">Можно вставлять любые форматы — парсер попробует вытащить
+                UUID/ГРНЗ/постановления.
+              </div>
+            </div>
+          </div>
+        </div>
+      </div>
+    </details>
+
+    <!-- 3) Parser -->
+    <details class="accordion" open id="parserSection">
+      <summary>
+        <div class="summary-title">
+          <span class="k">🔍 Парсер</span>
+          <span class="d">Результаты (постановления / UUID / ГРНЗ) + действия</span>
+        </div>
+        <span class="chev">›</span>
+      </summary>
+
+      <div class="accordion-body">
+        <!-- Keep original #result container + internal ids, only moved here -->
+        <div id="result" style="display:none;">
+          <div class="results-layout">
+            <div class="result-column">
+              <h3 style="color:#16a34a;">📜 Постановления</h3>
+              <div class="result-card main" id="cardNumMain" onclick="copyNumber()">
+                <div class="count-badge" id="mainCount">0</div>
+                <div class="result-title">📱 Номер постановления</div>
+                <div class="result-number" id="outputText"></div>
+              </div>
+              <div class="result-card sql" id="cardNumSql" onclick="copySQL()">
+                <div class="count-badge" id="sqlCount">0</div>
+                <div class="result-title">💾 SQL IN (...)</div>
+                <div class="result-number" id="sqlOutput"></div>
+              </div>
+              <div class="result-card num-csv" id="cardNumCsv" onclick="copyNumCsv()">
+                <div class="count-badge" id="numCsvCount">0</div>
+                <div class="result-title">📄 CSV</div>
+                <div class="result-number" id="numCsvOutput"></div>
+              </div>
+              <button id="queryDbBtn" class="query-button" style="display:none;">📡 Найти постановления в БД</button>
+            </div>
+
+            <div class="result-column">
+              <h3 style="color:#7c3aed;">🆔 UUID</h3>
+              <div class="result-card uuid-main" id="cardUuidMain" onclick="copyUUIDMain()">
+                <div class="count-badge" id="uuidMainCount">0</div>
+                <div class="result-title">🆔 UUID (главный)</div>
+                <div class="result-number" id="uuidOutput"></div>
+              </div>
+              <div class="controls">
+                <button id="btnUseParsedUuids" class="secondary" type="button">➡️ Использовать UUID в Sender</button>
+                <button id="btnFillGrnMode" class="secondary" type="button">⚙️ Подставить UUID + ГРНЗ в
+                  grn+comment</button>
+              </div>
+            </div>
+
+            <div class="result-column">
+              <h3 style="color:#ef4444;">🚗 ГРНЗ</h3>
+              <div class="result-card grz-main" id="cardGrzMain" onclick="copyGrzMain()">
+                <div class="count-badge" id="grzMainCount">0</div>
+                <div class="result-title">🚗 ГРНЗ (главный)</div>
+                <div class="result-number" id="grzOutput"></div>
+              </div>
+              <div class="result-card grz-sql" id="cardGrzSql" onclick="copyGrzSQL()">
+                <div class="count-badge" id="grzSqlCount">0</div>
+                <div class="result-title">💾 SQL IN (ГРНЗ)</div>
+                <div class="result-number" id="grzSqlOutput"></div>
+              </div>
+              <div class="result-card grz-csv" id="cardGrzCsv" onclick="copyGrzCsv()">
+                <div class="count-badge" id="grzCsvCount">0</div>
+                <div class="result-title">📄 CSV ГРНЗ</div>
+                <div class="result-number" id="grzCsvOutput"></div>
+              </div>
+            </div>
+          </div>
+
+          <div id="status" class="status"></div>
+          <div id="debug" class="debug"></div>
+
+          <div id="dbResultsContainer" class="db-results-container" style="display:none;">
+            <h3>Результаты из БД</h3>
+            <div id="dbResultsOutput"></div>
+          </div>
+        </div>
+
+        <div class="small-muted">
+          Если блок парсера пуст — вставь текст в “Источник текста” и запусти парсер (JS модуль сделает остальное).
+        </div>
+      </div>
+    </details>
+
+    <!-- 4) Operation -->
+    <details class="accordion" open id="operationSection">
+      <summary>
+        <div class="summary-title">
+          <span class="k">🧩 Операция</span>
+          <span class="d">Выбор режима + поля только выбранной операции</span>
+        </div>
+        <span class="chev">›</span>
+      </summary>
+
+      <div class="accordion-body">
+        <div class="row">
+          <div class="card soft">
+            <h2>Operation mode</h2>
+            <label>Режим</label>
+            <select id="mode" class="highlight-select">
+              <option value="pay_type">Сменить pay_type (body: { transaction_uuid, pay_type })</option>
+              <option value="class_change">Сменить class (body: { transaction_uuid, class })</option>
+              <option value="grn_comment">Отправить grn + comment (body: { transaction_uuid, grn, comment })</option>
+              <option value="pan_change">Сменить PAN (парсинг из текста) (body: { transaction_uuid, grn, comment })
+              </option>
+            </select>
+            <div class="hint">Ниже появятся только поля, которые нужны выбранному режиму.</div>
+          </div>
+
+          <div class="card soft" style="grid-column: span 2;">
+            <h2>Поля операции</h2>
+
+            <!-- pay_type fields -->
+            <div id="fields_pay_type" class="op-fields">
+              <div class="row two">
+                <div>
+                  <label>Pay type</label>
+                  <input id="payType" type="text" value="5" />
+                  <div class="hint">Используется только в режиме смены pay_type.</div>
+                </div>
+                <div>
+                  <label style="opacity:.9">Справка</label>
+                  <div class="small">Тело запроса: <b>{ transaction_uuid, pay_type }</b></div>
+                </div>
+              </div>
+            </div>
+
+            <!-- class_change fields -->
+            <div id="fields_class_change" class="op-fields">
+              <div class="row two">
+                <div>
+                  <label>Class</label>
+                  <select id="classValue">
+                    <option value="1">1</option>
+                    <option value="2">2</option>
+                    <option value="3">3</option>
+                    <option value="4" selected>4</option>
+                  </select>
+                  <div class="hint">Допустимые классы: 1, 2, 3, 4.</div>
+                </div>
+                <div>
+                  <label style="opacity:.9">Справка</label>
+                  <div class="small">Тело запроса: <b>{ transaction_uuid, class }</b></div>
+                  <div class="small">API: <b>/api/ui/find-transactions/set_class</b></div>
+                </div>
+              </div>
+
+            </div>
+
+            <!-- grn_comment fields -->
+            <div id="fields_grn_comment" class="op-fields">
+              <div class="row">
+                <div>
+                  <label>GRN</label>
+                  <input id="grn" type="text" placeholder="например T732YE797" />
+                </div>
+                <div>
+                  <label>COMMENT</label>
+                  <input id="comment" type="text" placeholder="например 8667" />
+                </div>
+                <div>
+                  <label style="opacity:.9">Справка</label>
+                  <div class="small">Тело запроса: <b>{ transaction_uuid, grn, comment }</b></div>
+                </div>
+              </div>
+            </div>
+
+            <!-- pan_change fields -->
+            <div id="fields_pan_change" class="op-fields">
+              <div class="row one">
+                <div>
+                  <div class="small-muted">
+                    Режим PAN: парсинг идёт из текста обращения. Обычно используется связка <b>transaction_uuid + grn +
+                      comment</b> (как в grn_comment).
+                    <br />Если у тебя есть отдельное поле для PAN — добавь сюда, и в JS сформируй body.
+                  </div>
+                </div>
+              </div>
+
+              <!-- оставляем те же поля grn/comment (они нужны и для pan_change по твоему описанию) -->
+              <div class="row">
+                <div>
+                  <label>GRN</label>
+                  <input id="grn_pan_mirror" type="text"
+                    placeholder="например T732YE797 (можно оставить пустым, если берёшь из парсера)" />
+                  <div class="hint">Это зеркало, чтобы не мешать основным id. Если хочешь — убери и используй
+                    #grn/#comment.</div>
+                </div>
+                <div>
+                  <label>COMMENT</label>
+                  <input id="comment_pan_mirror" type="text" placeholder="например 8667" />
+                </div>
+                <div>
+                  <label style="opacity:.9">Справка</label>
+                  <div class="small">Тело запроса (как сейчас): <b>{ transaction_uuid, grn, comment }</b></div>
+                </div>
+              </div>
+            </div>
+
+            <div class="hint">Примечание: для совместимости с текущим JS, базовые поля оставлены с теми же id (#payType,
+              #grn, #comment).</div>
+          </div>
+        </div>
+      </div>
+    </details>
+
+    <!-- 5) Import UUID -->
+    <details class="accordion" open id="importSection">
+      <summary>
+        <div class="summary-title">
+          <span class="k">📄 Импорт UUID</span>
+          <span class="d">Файл / textarea + правила извлечения</span>
+        </div>
+        <span class="chev">›</span>
+      </summary>
+
+      <div class="accordion-body">
+        <div class="row">
+          <div class="card soft">
+            <h2>Источник UUID</h2>
+            <label>Источник</label>
+            <select id="source" class="highlight-select">
+              <option value="file">CSV / TXT файл</option>
+              <option value="textarea">Поле ввода (textarea)</option>
+            </select>
+
+            <label style="margin-top:10px">CSV / TXT файл</label>
+            <input id="csvFile" type="file" accept=".csv,.txt" />
+            <div class="hint">Можно таблицу с колонками или просто список UUID в строках.</div>
+          </div>
+
+          <div class="card soft">
+            <h2>Ручной ввод UUID / CSV</h2>
+            <label>Textarea</label>
+            <textarea id="textArea" placeholder="uuid1\nuuid2\nили transaction_uuid,grn,..."></textarea>
+            <div class="hint">Разделители: переносы строки, запятая, ;, пробелы, табы. Header тоже поддерживается.</div>
+          </div>
+
+          <div class="card soft">
+            <h2>Опции импорта</h2>
+
+            <label>UUID column name (если в CSV header)</label>
+            <input id="uuidCol" type="text" placeholder="transaction_uuid (опционально)" />
+            <div class="hint">Если CSV имеет header — укажи имя столбца; иначе система попробует найти UUID
+              автоматически.
+            </div>
+
+            <div class="optlist" style="margin-top:10px">
+              <label><input id="fastExtract" type="checkbox" checked /> Быстрое извлечение UUID из любого текста
+                (например
+                smena-pan.txt)</label>
+              <label><input id="useFirstColIfHeader" type="checkbox" checked /> Если header не указан — брать первую
+                колонку</label>
+              <label><input id="skipPreview" type="checkbox" /> Пропускать Preview перед Send All (не
+                рекомендовано)</label>
+              <label><input id="autoDownloadErrors" type="checkbox" /> Скачать errors.csv автоматически</label>
+              <label><input id="autoClosePeriods" type="checkbox" /> Автозакрытие периодов после успешной
+                отправки</label>
+            </div>
+          </div>
+        </div>
+      </div>
+    </details>
+
+    <!-- 6) Sending -->
+    <details class="accordion" open id="sendSection">
+      <summary>
+        <div class="summary-title">
+          <span class="k">🚀 Отправка</span>
+          <span class="d">Preview → Send 1 → Send All + отчёты</span>
+        </div>
+        <span class="chev">›</span>
+      </summary>
+
+      <div class="accordion-body">
+        <div class="card soft">
+          <div class="controls split">
+            <div class="btn-group">
+              <button id="btnPreview">Preview (первые 10)</button>
+              <button id="btnSendOne" class="secondary">Send 1 (тест)</button>
+            </div>
+
+            <div class="btn-group">
+              <button id="btnSendAll">Send All</button>
+              <button id="btnPause" class="secondary" disabled>Pause</button>
+              <button id="btnStop" class="warn" disabled>Stop</button>
+            </div>
+
+            <div class="btn-group">
+              <button id="btnDownloadErrors" class="secondary">Скачать errors.csv</button>
+              <button id="btnDownloadReport" class="secondary">Скачать report.csv</button>
+            </div>
+          </div>
+
+          <div class="small-muted" style="margin-top:10px">
+            Совет: Preview → Send 1 → Send All
+          </div>
+
+          <h3 style="margin-top:14px">PREVIEW</h3>
+          <div id="previewBox"></div>
+
+          <div class="footer">
+            <div class="hint">Поддерживаемые форматы в textarea: простые строки UUID, CSV с header, разделители:
+              запятая,
+              ;, пробелы, табы, переносы строки.</div>
+          </div>
+        </div>
+      </div>
+    </details>
+
+    <!-- 7) DB & periods -->
+    <details class="accordion" open id="dbSection">
+      <summary>
+        <div class="summary-title">
+          <span class="k">🗄️ БД / Периоды</span>
+          <span class="d">Поиск/результаты и SQL открыть/закрыть периоды</span>
+        </div>
+        <span class="chev">›</span>
+      </summary>
+
+      <div class="accordion-body">
+        <div class="row two">
+          <div class="card soft">
+            <h2>Периоды</h2>
+            <div class="controls">
+              <button id="btnOpenPeriods" class="secondary">Открыть периоды (SQL)</button>
+              <button id="btnClosePeriods" class="secondary">Закрыть периоды (SQL)</button>
+            </div>
+            <div class="hint">Обычно это вспомогательные команды — держим рядом с БД.</div>
+          </div>
+
+          <div class="card soft">
+            <h2>Поиск в БД</h2>
+            <div class="small-muted">
+              Кнопка “📡 Найти постановления в БД” показывается парсером при необходимости (id сохранён: #queryDbBtn).
+            </div>
+            <div class="hint">Результаты появятся в блоке парсера (таблица) — id сохранён.</div>
+          </div>
+        </div>
+      </div>
+    </details>
+
+    <!-- 8) Logs (UNCHANGED) -->
+    <details class="accordion" open id="logsSection">
+      <summary>
+        <div class="summary-title">
+          <span class="k">🧾 Логи</span>
+          <span class="d">Оставлено без изменений</span>
+        </div>
+        <span class="chev">›</span>
+      </summary>
+
+      <div class="accordion-body">
+        <h3>Логи</h3>
+        <div id="logBox"></div>
+      </div>
+    </details>
+
+  </div>
+
+  <!-- Small helper: show/hide operation fields based on #mode -->
+  <script>
+    (function () {
+      const mode = document.getElementById('mode');
+      const modeSidebar = document.getElementById('modeSidebar');
+      const pill = document.getElementById('modePill');
+
+      const blocks = {
+        pay_type: document.getElementById('fields_pay_type'),
+        class_change: document.getElementById('fields_class_change'),
+        grn_comment: document.getElementById('fields_grn_comment'),
+        pan_change: document.getElementById('fields_pan_change')
+      };
+
+      function applyMode(source) {
+        const v = source?.value || mode?.value || modeSidebar?.value || 'pay_type';
+        if (mode && mode.value !== v) mode.value = v;
+        if (modeSidebar && modeSidebar.value !== v) modeSidebar.value = v;
+        if (pill) pill.textContent = v;
+        Object.keys(blocks).forEach(k => {
+          if (!blocks[k]) return;
+          blocks[k].classList.toggle('active', k === v);
+        });
+      }
+
+      if (mode) {
+        mode.addEventListener('change', () => applyMode(mode));
+      }
+
+      if (modeSidebar) {
+        modeSidebar.addEventListener('change', () => applyMode(modeSidebar));
+      }
+
+      applyMode(mode);
+    })();
+  </script>
+
+  <!-- Your existing modules -->
+  <script src="js-bs-6/tema.js"></script>
+  <script type="module" src="js-bs-6/main.js"></script>
+  <script type="module" src="js-bs-6/parser/main.js"></script>
+  <script type="module" src="js-bs-6/ticket_parser.js"></script>
+
+</body>
+
 </html>
\ No newline at end of file
 
EOF
)